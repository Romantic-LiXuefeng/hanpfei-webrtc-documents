---
title: ALSA SoC 层概述
date: 2023-04-29 15:29:29
categories: Linux 内核
tags:
- Linux 内核
---

***[尽管 Linux 内核的文档对于 Linux 内核的描述比较权威，但它们也可能会过时。Linux 内核文档中关于 ASoC 的这几份文档，仅能看作是对于 ASoC 子系统的一些概念的介绍，而难以作为编写相关驱动程序的精确指南，这几份文档所描述的内容，已经与当前版本的内核代码相去甚远。]***

ALSA 片上系统 (ASoC) 层的总体项目目标是为嵌入式片上系统处理器 (比如 pxa2xx，au1x00，iMX 等) 和便携式音频 codecs 提供更好的 ALSA 支持。在 ASoC 子系统出现之前，内核中也有一些对 SoC 音频的支持，但它有一些限制：

 * Codec 驱动通常与底层 SoC CPU 紧密耦合。这并不理想，而且会导致重复代码 —— 比如，Linux 为 4 个不同的 SoC 平台具有不同的 wm8731 驱动。

 * 没有标准的方法来通知用户发起的音频事件 (例如，耳机/麦克风插入，插入事件后的耳机/麦克风检测)。这是便携式设备上非常常见的事件，并且在这些事件之后，常常需要特定于机器的代码来重新路由音频，开启放大器等。

 * 当播放（或录制）音频时，驱动程序倾向于开启整个 codec。这对于 PC 来说没什么问题，但是对于便携式设备来说却会浪费大量电源。且不支持通过改变 codec 过采样率，偏置电流等来节省电源。

## ASoC 设计

ASoC 层旨在解决这些问题并提供以下特性：

 * Codec 独立性。允许在其它平台和机器上复用 codec 驱动程序。

 * 简单的 codec 和 SoC 之间的 I2S/PCM 音频接口设置。每个 SoC 接口和 codec 向核心注册它的音频接口能力，并在应用硬件参数已知时进行匹配和配置。

 * 动态音频电源管理 (Dynamic Audio Power Management，DAPM)。DAPM 总是自动将 codec 设置为最小功率状态。这包括根据内部的 codec 音频路由和任何活动的流开启/关闭内部电源模块。

 * 弹出和点击消除。通过以正确的顺序为 codec 供电 (包括使用数字静音)，可以减少弹出和点击。ASoC 通知 codec 何时改变电源状态。

* 特定于机器的控制：允许机器添加声卡控制 (例如扬声器放大器的音量控制)。

为了实现这一切，ASoC 基本上将嵌入式音频系统拆分为多个可复用的组件驱动程序：

 * Codec 类驱动程序：Codec 类驱动程序是平台独立的，且包含音频控制，音频接口能力，codec DAPM 定义和 codec IO 功能。如果需要，这种类别可以扩展到 BT，FM 和 MODEM IC。Codec 类驱动程序应该是可以运行在任何架构和机器上的通用代码。

 * 平台类驱动程序：平台类驱动程序包括音频 DMA 引擎驱动程序，数字音频接口 (DAI) 驱动程序 (比如 I2S，AC97，PCM) 及任何该平台的音频 DSP 驱动程序。

 * 机器类驱动程序：机器类驱动程序扮演胶水的角色，它描述并把其它组件驱动程序绑定在一起，形成一个 ALSA “声卡设备”。它处理任何特定于机器的控制和机器级音频事件 (比如，在播放开始时打开放大器)。

[原文](linux-kernel/Documentation/sound/soc/overview.rst)

Done.
