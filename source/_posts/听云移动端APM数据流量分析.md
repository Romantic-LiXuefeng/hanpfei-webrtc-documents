---
title: 听云移动端APM数据流量分析
date: 2017-04-12 15:17:49
categories: 网络调试
tags:
- 网络调试
---

借助于 Wireshark，我们通过抓包对听云 Android SDK 的网络行为进行了分析。

# 宿主 App 无网络请求情况下的数据交互

先来看一下，在宿主 App 没有任何的网络请求的情况下，听云移动端 SDK 与其服务器之间的数据交互。

在初始化阶段，听云移动端会与其服务器建立一条 TLS 连接，传输一些数据。如下图，自 第 6 号包开始：
![](https://www.wolfcstech.com/images/1315506-769decf348326d34.png)

在 TCP 连接建立之前，看不到有 DNS 的请求，因而推测这个连接是与 SDK 中事先埋的一个静态 IP 地址，或之前缓存的某个 IP 地址建立的。目前这个 IP 地址是 `106.75.75.218`。我们以这个 IP 地址过滤数据包：
![](https://www.wolfcstech.com/images/1315506-07a2fced44651a09.png)

发现只有 SDK 初始化阶段与这个 IP 地址存在数据交互。Follow 这个 TCP Stream：
![](https://www.wolfcstech.com/images/1315506-e2c077a609617a23.png)

发现这个 TCP 流中，传输的数据总量为 4824 bytes，其中移动端发送数据 744 bytes，接收数据 4080 bytes，其中服务器向移动端发送的数据中大部分是 TLS 证书。

第 29 号包，可以看到，前述的TCP连接断开了。

前述 TCP 连接断开之后，我们看到从移动端发出了一个 DNS 请求，即第 30 号包，查询的域名是 `dc1.networkbench.com`。域名服务器返回的查询结果，也就是第 31 号包，如下：
![](https://www.wolfcstech.com/images/1315506-5e2c161c514a5f64.png)

随后移动端与 `dc1.networkbench.com` 建立了一条 TLS 连接，从第 32 号包开始：
![](https://www.wolfcstech.com/images/1315506-1fa169fdea138802.png)

自此听云 SDK 与其服务器，大概每隔 1 分钟左右有一次数据交互：
![](https://www.wolfcstech.com/images/1315506-908272266db61cd6.png)

![](https://www.wolfcstech.com/images/1315506-ae57d68321a79c4d.png)

![](https://www.wolfcstech.com/images/1315506-b67b8af1f5a9e713.png)

![](https://www.wolfcstech.com/images/1315506-4a1b7567956faa72.png)

![](https://www.wolfcstech.com/images/1315506-8a2d3ad05e2cd1da.png)

从 14:02:26 左右，一直持续到 14:08:26，总共 7 次数据交互。Follow 这个数据流，可以看到通过这个 TCP 连接，传输的数据总量为 22176 bytes，其中移动端发送 12410 bytes，接收 9766 bytes。
![](https://www.wolfcstech.com/images/1315506-bc66363d450c2541.png)

移动端接收的数据中，TLS 证书大概占到 `3 ～ 4 K`。在移动端宿主 App 没有任何网络请求的情况下，平均每分钟听云的移动端向其服务器发送 `1.6 K` 的数据。

从第 433 号包 14:08:31 开始，到第 820 号包 14:15:31 结束，几乎是完全重复了上面的过程：
![](https://www.wolfcstech.com/images/1315506-356b837272eede1d.png)

![](https://www.wolfcstech.com/images/1315506-858a0a2ed3d655a2.png)

不过这次是持续了 7 分钟，完成了 8 此数据交互，传输数据总量 22123 bytes，其中移动端发送数据 13023 bytes ，接收 9100 bytes。

随后又经历了一个与上面非常相似的过程。
![](https://www.wolfcstech.com/images/1315506-cafa30165827fd32.png)

这一次从  14:15:31 开始，持续到第 1065 号包 14:22:52 结束。这一次传输数据总量要大一些，为 26646 bytes，其中移动端发送数据 15965 bytes ，接收 10681 bytes。

随后从第 1068 号包到 1095 号包，听云移动端与其服务器再一次建立了一条 TLS连接：
![](https://www.wolfcstech.com/images/1315506-26fc9506111f72cd.png)

这一次交互了少量数据之后，连接就断开了。

自此之后，在也没有抓到听云的数据包了。

这个过程持续了总共大概 22 分钟。

# 宿主 App 有网络请求情况下的数据交互

接下来我们看一下在宿主 App 有网络请求的情况下，听云 SDK 的数据流量有什么不同的地方。

如我们前面看到的，听云 SDK 的连接的生命周期大概为 7 分钟，数据交互的周期为
 1 分钟，我们主要分析在连接的一个生命周期中，宿主 App 执行不同频率的网络请求，SDK 数据流量的变化。

我们的测试是这样的：
1. 在第一个数据交互周期中，宿主 App 不执行任何的网络请求。
![](https://www.wolfcstech.com/images/1315506-cd610fddd062a108.jpg)
如上图第 64 号包是第一个数据交互周期的最后一个数据包，第 70 号包是第二个数据交互周期的第一个数据包。

2. 在第二个数据交互周期中，我们控制宿主 App 执行 3 次小网络请求，每个请求传输的数据量在 几 K 这一量级。
![](https://www.wolfcstech.com/images/1315506-bdd171feee5421f8.jpg)
如上图的第 110 号包到第 137 号包之间。

3. 在第三个数据交互周期中，我们控制宿主 App 执行 1 次小网络请求，请求数据量为 1K 多一点。
![](https://www.wolfcstech.com/images/1315506-aa75fde303491c41.jpg)

4. 在第四个数据交互周期，我们执行大量的小网络请求，准确地说是接近 100 个请求。
![](https://www.wolfcstech.com/images/1315506-116605668f06a4e3.jpg)

5. 在第五个数据交互周期中，宿主 App 执行 4 个小的网络请求。

6. 后面宿主 App 不再执行网络请求。

经过上面的操作，我们最终得到如下的 TCP 流图：

![移动端数据发送 TCP 流图](https://www.wolfcstech.com/images/1315506-9545cbd8f876b51c.jpg)

连接建立初始化阶段，发送了 2845 bytes。
第一个数据交互周期，发送 4641 － 2845 ＝ 1796 bytes
第二个数据交互周期，发送 6778 － 4641 ＝ 2137 bytes
第三个数据交互周期，发送 8654 － 6778 ＝ 1876 bytes
第四个数据交互周期，发送 10983 － 8654 ＝ 2329 bytes
第五个数据交互周期，发送 12850 － 10983 ＝ 1867 bytes
第六个数据交互周期，发送 14655 － 12850 ＝ 1805 bytes
第七个数据交互周期，发送 16451 － 14655 ＝ 1796 bytes

从中可以看到，
1. 在宿主 App 没有网络请求时，一个数据交互周期发送的数据量大概为 1800 bytes。
2. 第二个数据交互周期中，我们第一次控制宿主 App 执行了网络请求，因而，在这个数据交互周期中，传输的数据量增大了不少。
3. 宿主的网络请求越多，平均每个网络请求消耗的流量就越少。宿主平均每个网络请求消耗的流量在 6 bytes ～76 bytes 之间。

![移动端数据接收 TCP 流图](https://www.wolfcstech.com/images/1315506-ede5dc2192839d91.jpg)

在连接建立阶段，由于 TLS 连接建立要下发证书，因而有了 5477 bytes 的流量消耗。
第一个数据交换周期，移动端接收数据 6286 － 5477 ＝ 809 bytes
第二个数据交换周期，移动端接收数据 6813 － 6286 ＝ 527 bytes
第三个数据交换周期，移动端接收数据 7830 － 6813 ＝ 1017 bytes
第四个数据交换周期，移动端接收数据 8394 － 7830 ＝ 564 bytes
第五个数据交换周期，移动端接收数据 9203 － 8394 ＝ 809 bytes
第六个数据交换周期，移动端接收数据 9975 － 9203 ＝ 772 bytes
第七个数据交换周期，移动端接收数据 10747 － 9975 ＝ 772 bytes

# 总结

听云 SDK 与其服务器通过 TLS 加密传输，因而数据传输的具体格式难以判断。

在宿主 App 无网络请求的情况下，听云移动端 SDK 与其服务器大概会经历 初始化 -> 数据交互 -> 数据交互停止 这样几个阶段，整个过程持续大约 23 分钟。数据交互通过 3 条 TLS 连接完成，每条连接生命周期为 7 分钟，数据交互大约每分钟执行一次，每次数据交互上传数据量大约 1.6 KBytes。

在宿主 App 有网络请求的情况下，听云移动端 SDK 与其服务器之间的数据交互行为，与在宿主 App 无网络请求的情况下的行为基本上已知。在数据交互的点之前发生宿主 App 的网络请求的相关信息会被该次数据上传带到服务器。抛开每次数据上传的基本数据 1.8 KBytes，宿主 App 平均每个网络请求上传的数据量大约在 6 bytes ～ 76 bytes 之间。