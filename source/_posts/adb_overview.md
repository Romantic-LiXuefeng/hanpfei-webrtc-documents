---
title: 关于 ADB 实现的说明
date: 2017-11-20 10:05:49
categories: Android开发
tags:
- Android开发
- 翻译
---

# I.总体概述

Android 调试桥（ADB）用于：

 - 跟踪所有连接的或运行于给定开发者主机上的 Android 设备和模拟器实例。
 - 为客户端（命令行用户，或像 DDMS 这样的辅助程序）实现各种控制命令（比如，"adb shell"，"adb pull"，等等）。这些命令在 ADB 中称为 'service'。
<!--more-->
总的来说，一切工作通过以下组件完成：

1. ADB server

这是一个运行于主机上的后台进程。它的目的是为了感知USB端口，以了解何时连接/移除设备，以及模拟器实例何时启动/停止。

它必须维护一个 “已连接设备” 列表并为它们中的每一个分配一个 ‘状态’：OFFLINE，BOOTLOADER，RECOVERY 或 ONLINE（下面还有更多）。

ADB server 真的是一个巨大的多路复用循环，它的目的是编排客户端，服务和设备之间的数据（包，真正的）交换。

2. ADB 守护进程（adbd）

'adbd' 作为 Android 设备或模拟器系统内的后台进程运行。它的目的是连接 ADB server（对于设备来说是通过 USB，对于模拟器来说是通过 TCP）并为运行在主机上的客户端提供一些服务。

当 ADB server 已经成功地连接到设备内部的 adbd 时，它才认为设备是 ONLINE 的。否则，设备是 OFFLINE 的，这意味着 ADB server 探测到了一个新的设备/模拟器，但无法连接到 adbd 守护进程。

BOOTLOADER 和 RECOVERY 状态对应于处在 bootloader 或 recovery 模式下的设备相应的状态。

3. ADB 命令行客户端

'adb' 命令行程序用于在 shell 或脚本中运行 adb 命令。它首先尝试定位主机上的 ADB server，如果没有它将会自动地启动一个。

然后，客户端给 ADB server 发送它的服务请求。它无需知道。

当前，一个单独的 'adb' 二进制文件同时被用作服务器和客户端。这使得分发和启动服务器更简单。

4. 服务

基本上有两种客户端可以与之交互的服务。

Host 服务：
 - 这些服务运行于 ADB server 内，且一点也不需要与设备通信。一个典型的例子是 "adb devices"，它被用于返回当前已知的设备和它们的状态的列表。尽管如此，他们还是一些其他的服务。

Local 服务：
这些服务或者运行于 adbd 守护进程内，或者由它在设备上启动。ADB server 用于在客户端和运行于 adbd 内的服务间多路复用流。在这种情况下，它的角色是初始化连接，然后作为一个数据通道。

# II. 协议细节

## 1. 客户端 <-> 服务器协议

这里详述 ADB 客户端和 ADB server 本身之间使用的协议。ADB server 监听在 TCP:localhost:5037 上。

客户端使用如下的格式发送一个请求：

 1. 给出了有效载荷长度的 4 字节十六进制字符串
 2. 然后是载荷本身。

比如，要向 ADB server 查询它内部的版本号，客户端将执行如下动作：

 1. 连接 tcp:localhost:5037
 2. 向对应的 socket 发送字符串 "000Chost:version"。

'host:' 前缀用于表示请求发往服务器本身（我们稍后将讨论其它种类的请求）。内容长度以 ASCII 编码，以方便调试。

服务器应该以如下几种方式之一响应一个请求：
 1. 请求成功：4 字节的 "OKAY" 字符串
 2. 请求失败，4 字节的 "FAIL" 字符串，接着是一个 4 字节的十六进制长度，接着是一个字符串给出了失败的原因。
 3. 作为一个特殊的扩展，'host:version'，一个 4 字节的十六进制字符串对应于服务器的内部版本号

注意在 OKAY 之后，连接依然是存活的，这允许客户端执行其它的请求。但是在某些情况下，OKAY 将甚至改变连接的状态。

比如，在 'host:transport:<serialnumber>' 请求的情况中，其中 '<serialnumber>' 用于标识一个给定的设备/模拟器；在 "OKAY" 应答之后，客户端执行的所有进一步的请求将直接进入对应的 adbd 守护进程。

文件 SERVICES.TXT 列出了 ADB 当前实现的所有服务。

## 2. 传输

ADB 传输建模了 ADB server 和一个设备或模拟器间的连接。当前有两种类型的传输：

 - USB 传输，用于通过 USB 连接的物理设备
 - 本地传输，用于在主机上运行的模拟器，通过 TCP 与服务器连接

理论上来说，编写一个本地传输，代理 ADB server 和连接到/运行于另一台机器上的设备/模拟器之间的连接应该是可能的。尽管这还没有完成。

每个传输可以携带一个或多个客户端和它们指向的设备/模拟器间的多路复的用流。ADB server 必须适当地处理意外的传输中断（比如，当设备被物理拔除时）。

[翻译原文](http://androidxref.com/8.0.0_r4/xref/system/core/adb/OVERVIEW.TXT)

### [打赏](https://www.wolfcstech.com/about/donate.html)
