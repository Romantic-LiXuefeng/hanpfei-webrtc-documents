---
title: 交互式连接建立 (ICE)：一种用于网络地址转换 (NAT) 穿越的协议 II
date: 2022-01-08 12:35:49
categories: 网络协议
tags:
- 网络协议
---

# 7. 执行连接性检查

本节介绍如何执行连接性检查。

ICE 代理必须符合[[RFC5389](https://www.rfc-editor.org/rfc/rfc5389)]。一个完整的实现同时充当 STUN 客户端和 STUN 服务器，而一个精简实现只充当 STUN 服务器 (因为它不生成连接检查)。

## 7.1. STUN 扩展 

ICE 通过以下属性扩展了 STUN：PRIORITY，USE-CANDIDATE，ICE-CONTROLLED，和 ICE-CONTROLLING。这些属性的正式定义见 [第16.1节](https://www.rfc-editor.org/rfc/rfc8445.html#section-16.1)。本节介绍属性的使用方法。

这些属性仅适用于 ICE 连接性检查。

### 7.1.1. PRIORITY

PRIORITY 属性 必须 (MUST) 包含在 Binding 请求中，并被设置为 [第 5.1.2 节](https://www.rfc-editor.org/rfc/rfc8445.html#section-5.1.2) 中为本地候选地址计算优先级的算法计算的值，但具有对等自反候选地址的候选地址类型优先级。

### 7.1.2. USE-CANDIDATE

为了提名候选地址对 ([章节 8.1.1](https://www.rfc-editor.org/rfc/rfc8445.html#section-8.1.1))，控制代理 必须 (MUST) 包含 USE-CANDIDATE 属性。受控代理 绝不能 (MUST NOT) 在 Binding 请求中包含 USE-CANDIDATE 属性。

### 7.1.3. ICE-CONTROLLED 和 ICE-CONTROLLING

控制代理必须在 绑定 (Binding) 请求中包含 ICE-CONTROLLING 属性。受控代理必须在 绑定 (Binding) 请求中包含 ICE-CONTROLLED 属性。

当 ICE 角色冲突发生时 ([章节 7.3.1.1](https://www.rfc-editor.org/rfc/rfc8445.html#section-7.3.1.1))，这两个属性的内容将被用作决胜局值。
 
## 7.2. STUN 客户端过程

### 7.2.1. 为中继候选地址创建权限

如果使用中继的本地候选地址发送连接性检查，客户端 必须 (MUST) 首先创建一个权限，如果之前没有创建权限的话。如果它已经告诉 TURN 服务器为给定的中继候选地址创建一个到远程候选地址的 IP 地址的权限，那么它将在之前已经创建了一个。要创建权限，ICE 代理遵循 [[RFC5766](https://www.rfc-editor.org/rfc/rfc5766)] 中定义的过程。权限 必须 (MUST) 创建为到远程候选地址的 IP 地址。建议 (RECOMMENDED) 代理将 TURN 通道的创建延迟到 ICE 完成，在这种情况下，连接性检查的权限通常使用 CreatePermission 请求创建。一旦建立，代理 必须 (MUST) 保持权限活跃，直到 ICE 结束。

### 7.2.2. 形成凭据

连接检查 绑定 (Binding) 请求必须利用 STUN 短期凭据机制。

凭据的用户名是将对等体提供的用户名片段与发送请求的 ICE 代理的用户名片段连接起来形成的，中间用冒号 (":") 分隔。

密码为对等体提供的密码。

例如，考虑 ICE 代理 L是发起代理，而 ICE 代理 R 是响应代理的情况。代理 L 为它的候选地址包含 LFRAG 的用户名片段和 LPASS 的密码。代理 R 提供了 RFRAG 的用户名片段和 RPASS 的密码。从 L 到 R 的连接性检查利用了用户名 RFRAG:LFRAG 和密码 RPASS。从 R 到 L 的连接性检查使用用户名 LFRAG:RFRAG 和密码 LPASS。响应使用与请求相同的用户名和密码 (注意，响应中没有 USERNAME 属性)。

### 7.2.3. 差异化处理

如果代理在它将要发送的数据包中使用 差异化服务代码点 DSCP 标记 [[RFC2475](https://www.rfc-editor.org/rfc/rfc2475)]，那么代理 应该 (SHOULD) 对它将要发送的绑定请求和响应应用相同的标记。

如果数据包上使用了多个 DSCP 标记，则代理应该 (SHOULD) 选择其中一个标记进行连通性检查。

### 7.2.4. 发送请求

连接性检查通过从与本地候选地址相关联的基向远程候选地址发送绑定 Binding 请求来生成。[[RFC5389](https://www.rfc-editor.org/rfc/rfc5389)] 描述了如何构造和生成绑定请求。

执行连接性检查时，绝对不能 (MUST NOT) 假定支持 [RFC 3489](https://www.rfc-editor.org/rfc/rfc3489) 的向后兼容性。必须使用FINGERPRINT 机制进行连接性检查。

### 7.2.5. 处理响应

本节定义了处理特定于 ICE 连接性检查的绑定响应的附加过程。

当收到绑定响应时，使用事务 ID [[RFC5389](https://www.rfc-editor.org/rfc/rfc5389)] 将它与相应的绑定请求关联起来，然后该事务 ID 也将响应与发送绑定请求的候选地址对相关联。之后，根据角色冲突、失败或成功的过程 (根据下面的过程) 处理响应。

#### 7.2.5.1. 角色冲突

如果 绑定 (Binding) 请求产生了 487 (Role Conflict) 错误响应 ([章节7.3.1.1](https://www.rfc-editor.org/rfc/rfc8445.html#section-7.3.1.1))，并且如果 ICE 代理在请求中包含了 ICE-CONTROLLED 属性，则代理 必须 (MUST) 切换到控制角色。如果代理在请求中包含了 ICE-CONTROLLING 属性，则代理 必须 (MUST) 切换到受控角色。

当代理切换了角色后，必须 (MUST) 将连接性检查生成了 487 错误响应的候选地址对添加到与候选地址对所属检查列表相关的触发检查队列中，并将候选地址对状态设置为 Waiting。当稍后执行触发的连接性检查时，Binding 请求的 ICE-CONTROLLED / ICE-CONTROLLED 属性将指示代理的新角色。代理必须更改 tiebreaker 值。

注意：角色切换需要代理重新计算候选地址对的优先级 ([章节6.1.2.3](https://www.rfc-editor.org/rfc/rfc8445.html#section-6.1.2.3))，因为优先级值取决于角色。

注意：角色切换也会影响代理是否负责提名候选地址对，以及代理是否负责在 ICE 结束后发起与对等体交换更新后的候选地址信息。

#### 7.2.5.2. 失败

本节介绍候选地址对状态设置为失败的情况。

注意：当 ICE 代理由于连接性检查错误而将候选地址对状态设置为失败时，不会改变其它具有相同基的候选地址对的状态。

##### 7.2.5.2.1. 非对称传输地址

ICE 代理必须检查绑定请求和响应中的源和目的传输地址是否对称。即，响应的源 IP 地址和端口必须 (MUST) 等于发送绑定请求的目标 IP 地址和端口，响应的目标 IP 地址和端口必须 (MUST) 等于发送绑定请求的源 IP 地址和端口。如果地址不对称，代理必须 (MUST) 将候选地址对状态设置为失败 (Failed)。

##### 7.2.5.2.2. ICMP 错误

ICE 代理可以 (MAY) 为连接性检查支持对 ICMP 错误的处理。如果代理支持对 ICMP 错误的处理，且绑定 (Binding) 请求产生 ICMP 硬错误时，代理应该将候选地址对的状态设置为失败 (Failed)。在决定如何处理以及是否处理 ICMP 错误时，实现者需要意识到 ICMP 错误可以被用作拒绝服务攻击的一种方法。

##### 7.2.5.2.3. 超时

如果绑定请求事务超时，ICE 代理必须将候选地址对状态设置为失败 (Failed)。

##### 7.2.5.2.4. 不可恢复的 STUN 反应

如果绑定 (Binding) 请求产生的 STUN 错误响应是不可恢复的 [[RFC5389](https://www.rfc-editor.org/rfc/rfc5389)]， ICE 代理应该 (SHOULD) 将候选地址对状态设置为失败 (Failed)。

#### 7.2.5.3. 成功

如果下列条件都满足，则认为连接检查成功：

 * 绑定请求生成一个成功响应；以及
 * 绑定 (Binding) 请求和响应中的源和目标传输地址是对称的。

如果检查被认为是成功的，ICE 代理 (按顺序) 执行以下部分中描述的操作。

##### 7.2.5.3.1. 发现对等体自反候选地址

ICE 代理 必须 (MUST) 检查 STUN 响应中的映射地址。如果传输地址与代理所知道的任何本地候选地址不匹配，则映射的地址表示一个新的候选地址：对等体反射候选地址。和其它候选地址一样，对等体自反候选地址也有类型、基、优先级和基础。计算方法如下：

 * 类型为对等体自反
 * 基为发送绑定请求的候选地址对的本地候选地址。
 * 优先级为绑定请求中 PRIORITY 属性的值。
 * 基础描述如 [第 5.1.1.3 节](https://www.rfc-editor.org/rfc/rfc8445.html#section-5.1.1.3)。

然后对等体自反候选地址被加进数据流的本地候选地址列表中。用户名片段和密码与该流的所有其它本地候选地址的相同。

ICE 代理不需要将对等体自反候选地址与远程候选地址配对，因为有效的候选地址对将由于如 [第 7.2.5.3.2 节](https://www.rfc-editor.org/rfc/rfc8445.html#section-7.2.5.3.2) 中的过程而创建。如果代理想要将对等体自反候选地址与远程候选地址配对，而不是将被生成的有效候选地址对中的那个，代理 可以 (MAY) 提供更新的候选地址信息给包含对等体自反候选地址的对等体。这将会使得对等体自反候选地址与其它所有的远程候选地址配对。

##### 7.2.5.3.2. 构造一个有效对

ICE 代理构造一个候选地址对，其本地候选地址等于响应的映射地址，其远程候选地址等于请求发送的目标地址。这被称为 “有效对”。

有效对可能等于由连接性检查生成的对，检查列表中的一个不同的对，或者一个目前还不在检查列表中的对。

代理维护一个分开的列表，称为 “有效列表”。检查列表集中的每个检查列表 都有一个有效列表。有效列表将包含有效对。最初，每个有效列表都是空的。

有效列表中的每个有效对有一个标记，称为 “被提名标记”。当有效对被添加进有效列表时，标记值被设置为 'false'。

有效对将像下面这样被添加进一个有效列表中：

1. 如果有效对等于生成检查的对，则对被添加进与对所属的检查列表关联的有效列表；或者

2. 如果有效对等于检查列表中的另一个对，该对被添加进该对的检查列表所关联的有效列表。生成检查的对不被添加进有效列表中；或者

3. 如果有效对不在任何检查列表中，代理使用 [第 6.1.2 节](https://www.rfc-editor.org/rfc/rfc8445.html#section-6.1.2) 中的算法，基于每个候选地址对的优先级为该对计算优先级。本地候选地址的优先级依赖于它的类型。除非类型是对等体自反的，优先级等于在候选地址交换中为该候选地址用信号通知的。如果类型是对等体自反的，则它等于代理在刚刚完成的绑定请求中放置的 PRIORITY 属性的值。远程候选地址的优先级取自对等体的候选地址信息。如果其中没有候选地址出现，则检查是对新的远程候选地址的触发检查。在这种情况下，优先级被视为触发刚刚完成的检查的绑定请求中的 PRIORITY 属性的值。然后将该对添加到有效列表中。

注意：有效对不在任何检查列表中将非常常见。回忆一下，检查列表具有其本地候选地址不是自反的对；那些对已经将它们的本地候选地址转换为了自反候选地址的基，并且如果它们是冗余的则已经被修剪掉了。当绑定请求的响应到达时，如果在两者之间有 NAT，则映射地址将是自反的。在这种情况下，有效对将具有一个不与检查列表中的任何对匹配的本地候选地址。

##### 7.2.5.3.3. 更新候选地址对状态

ICE 代理将生成检查的候选地址对和构造的有效对（可能是不同的）的状态设置为成功 (Succeeded)。

代理 必须 (MUST) 将所有检查列表中具有相同的基础的所有其它冻结 (Frozen) 状态的候选地址对的状态设置为 等待 (Waiting) 。

注意：在给定的检查列表中，具有相同基础的候选地址对通常具有不同的组件 ID 值。

##### 7.2.5.3.4. 更新被提名标记

如果控制代理发送一个设置了 USE-CANDIDATE 属性的绑定请求，并且如果 ICE 代理接收到对该请求的成功响应，则代理设置该对的被提名标志为真 (true)。如果请求失败（[第 7.2.5.2 节](https://www.rfc-editor.org/rfc/rfc8445.html#section-7.2.5.2)），代理必须 (MUST) 从有效列表中删除候选对，将候选对状态设置为失败 (Failed) ，并将检查列表状态设置为失败 (Failed) 。

如果受控代理收到对代理发送的绑定请求的成功响应，并且该绑定请求是由接收到的设置了 USE-CANDIDATE 属性的绑定请求触发的（[第 7.3.1.4 节](https://www.rfc-editor.org/rfc/rfc8445.html#section-7.3.1.4)），则代理设置 对的被提名标记为真。如果触发的请求失败了，代理必须 (MUST) 从有效列表中删除候选对，将候选对状态设置为失败 (Failed) ，并将检查列表状态设置为失败 (Failed) 。

一旦为数据流的一个组件设置了被提名标志，它就结束了该组件的 ICE 处理（[第 8 节](https://www.rfc-editor.org/rfc/rfc8445.html#section-8)）。

#### 7.2.5.4. 检查列表状态更新

无论连接检查是成功还是失败，检查的完成都可能需要更新检查列表状态。对于检查列表集中的每个检查列表，如果所有候选对都处于失败或成功状态，并且如果在与检查列表关联的数据流的每个组件的有效列表中没有有效对，则检查列表的状态被设置为失败 (Failed)。如果有效列表中每个组件都有一个有效对，则检查列表的状态设置为成功 (Succeeded)。

## 7.3. STUN 服务器过程

ICE 代理（精简或完整）必须 (MUST) 准备好在每个它包含在它的最近的候选地址交换中的候选地址的基上接收绑定请求。

代理必须 (MUST) 使用短期凭证机制（即 MESSAGE-INTEGRITY 属性）来验证请求并执行消息完整性检查。同样，短期凭证机制必须 (MUST) 用于响应。如果用户名由冒号分隔的两个值组成，代理必须 (MUST) 认为用户名是有效的，其中第一个值等于代理在候选交换中为正在进行的会话生成的用户名片段。发起代理有可能（实际上很有可能）在从其对等体接收候选地址之前接收到绑定请求。如果发生这种情况，代理必须 (MUST) 立即生成响应（包括如 [第 7.3.1.2 节](https://www.rfc-editor.org/rfc/rfc8445.html#section-7.3.1.2) 所述计算映射地址）。此时代理有足够的信息来生成响应；不需要对等体的密码。收到应答后，必须 (MUST) 继续执行所需的其余步骤；即，完整的实现参见第 7.3.1.3、7.3.1.4 和 7.3.1.5 节。在应答之前收到多个 STUN 请求的情况，可能会导致多个对在触发检查队列中排队。

代理不得 (MUST NOT) 使用 ALTERNATE-SERVER 机制，也不得 (MUST NOT) 支持 [RFC 5389](https://www.rfc-editor.org/rfc/rfc5389) 中定义的向后兼容机制（用于使用 [RFC 3489](https://www.rfc-editor.org/rfc/rfc3489) 中的协议）。它必须使用 FINGERPRINT 机制。

如果代理在其数据包中使用 DSCP 标记 [[RFC2475](https://www.rfc-editor.org/rfc/rfc2475)]，它应该 (SHOULD) 将相同的标记应用于绑定响应。这同样适用于端点可能应用于数据包的任何第 2 层标记。

### 7.3.1. 完整实现的附加过程

当完整实现接受绑定请求时，本小节定义适用于完整实现的附加服务器过程。

#### 7.3.1.1. 探测并修复角色冲突

在 ICE 的某些用法（例如 3PCC）中，两个 ICE 代理最终可能会选择相同的角色，从而导致角色冲突。本节描述了一种检测和修复角色冲突的机制。使用文档必须 (MUST) 指定是否需要这种机制。

代理必须检查绑定请求的 ICE-CONTROLLING 或 ICE-CONTROLLED 属性。 它必须遵循以下过程：

 * 如果代理处于控制角色，并且请求中存在 ICE-CONTROLLING 属性：

     * 如果代理的 tiebreaker 值大于或等于 ICE-CONTROLLING 属性的内容，代理会生成一个绑定错误响应，并包含一个值为 487（角色冲突）的 ERROR-CODE 属性，但保留其角色。

     * 如果代理的 tiebreaker 值小于 ICE-CONTROLLING 属性的内容，则代理切换到受控角色。

 * 如果代理处于受控角色，并且请求中存在 ICE-CONTROLLED 属性：

     * 如果代理的 tiebreaker 值大于或等于 ICE-CONTROLLED 属性的内容，则代理切换到控制角色。

     * 如果代理的 tiebreaker 值小于 ICE-CONTROLLED 属性的内容，代理会生成一个绑定错误响应，并包含一个值为 487（角色冲突）的 ERROR-CODE 属性，但保留其角色。

 * 如果代理处于受控角色，并且请求中存在 ICE-CONTROLLING 属性，或者如果代理处于控制角色，并且请求中存在 ICE-CONTROLLED 属性，则不存在冲突。

角色的变化将需要代理重新计算对的优先级（[第 6.1.2.3 节](https://www.rfc-editor.org/rfc/rfc8445.html#section-6.1.2.3)），因为这些优先级是角色的函数。角色的变化还将影响代理是否负责选择提名的对并在 ICE 结束后发起更新的候选地址信息的交换。

如果代理对绑定请求产生了成功的响应，即使代理改变了角色，也会遵循 [第 7.3.1 节](https://www.rfc-editor.org/rfc/rfc8445.html#section-7.3.1) 中的其余小节。

#### 7.3.1.2. 计算映射地址

对于在中继候选地址上接收到的请求，用于 STUN 处理（即 XOR-MAPPED-ADDRESS 属性的生成）的源传输地址是 TURN 服务器看到的传输地址。如果绑定请求是通过数据指示 (Data Indication) 传递的，那么源传输地址将出现在数据指示 (Data Indication) 消息的 XOR-PEER-ADDRESS 属性中。如果绑定请求是通过 ChannelData 消息传递的，则源传输地址是绑定到通道的地址。

#### 7.3.1.3. 学习对等方自反候选地址

如果请求的源传输地址与任何现有的远程候选地址都不匹配，则它表示一个新的对等方自反远程候选地址。该候选地址构造如下：

 * 类型为对等方自反。

 * 优先级为绑定请求中 PRIORITY 属性的值。

 * 基础为一个任意值，不同于所有其它远程候选地址的基础。如果任何后续候选地址交换包含此对等方自反候选地址，它将通知此候选地址的实际基础。

 * 组件 ID 是请求被发送到的本地候选地址的组件 ID。

这个候选地址被添加进远程候选地址列表。然而，ICE 代理不将该候选地址与任何本地候选地址配对。

#### 7.3.1.4. 触发的检查

接下来，代理构造一个候选地址对，其本地候选地址的传输地址为接收 STUN 请求所在的地址 (如代理看到的)，远程候选地址等于请求所来自于的源传输地址 (可能是刚刚学习到的对等方自反远程候选地址)。本地候选地址将是主机候选地址（对于未通过中继接收请求的情况）或中继候选地址（对于通过中继接收的情况）。本地候选地址永远不能成为服务器自反候选地址。由于代理都知道这两个候选地址，因此它可以获取它们的优先级并计算候选地址的优先级。然后在检查清单中查找这个对。可能有以下几种结果之一：

 * 当这个对已经在检查列表上时：

     * 如果该对的状态为成功，则不再进行任何操作。

     * 如果该对的状态为进行中 (In-Progress)，则代理会取消进行中的 (In-Progress) 事务。取消意味着代理不会重新传输与连接检查事务相关联的绑定请求，不会将缺少响应视为失败，而是会等待事务超时的持续时间以获取响应。此外，代理必须把该对加入与检查列表关联的触发检查列表中，并将对的状态设置为等待 (Waiting)，以触发对的新连接检查。创建新的连接检查可以尽快验证正在进行的对，而无需等待与原始连接检查事务相关联的绑定请求的重新传输。

     * 如果该对的状态是 等待 (Waiting)、冻结 (Frozen) 或 失败 (Failed)，代理 必须 (MUST) 将该对排入与该检查列表关联的触发检查列表中（如果尚未存在），并将该对的状态设置为 等待 (Waiting)，以便触发该对的一个新连接检查。请注意，候选地址对从 失败 (Failed) 到 等待 (Waiting) 的状态更改也可能会触发关联的检查列表的状态更改。

当两个代理都在 NAT 之后时，完成这些步骤是为了促进 ICE 的快速完成。

 * 如果该对不在检查列表上：

     * 该对根据其优先级插入到检查列表中。

     * 它的状态被设置为 等待 (Waiting)。

     * 该对被排入触发检查队列。

当要发送触发的检查时，它会按照 [第 7.2.4 节](https://www.rfc-editor.org/rfc/rfc8445.html#section-7.2.4) 中的描述进行构造和处理。这些过程要求代理知道对等方的传输地址、用户名片段和密码。远程候选地址的用户名片段等于刚刚收到的绑定 (Binding) 请求中 USERNAME 的冒号后面的部分。使用该用户名片段，代理可以检查从其对等方收到的候选地址（在分叉的情况下可能有多个）并找到该用户名片段。然后选择相应的密码。

#### 7.3.1.5. 更新被提名标记

如果受控代理收到一个设置了 USE-CANDIDATE 属性的绑定 (Binding) 请求，且如果 ICE 代理接受请求，如下动作基于在 [7.3.1.4 节](https://www.rfc-editor.org/rfc/rfc8445.html#section-7.3.1.4) 中计算的对的状态：

 * 如果该对的状态为成功 (Succeeded)，它意味着该对之前发送的检查产生了一个成功的响应并生成了一个有效对（[7.2.5.3.2 节](https://www.rfc-editor.org/rfc/rfc8445.html#section-7.2.5.3.2)）。代理将有效对的被提名标记值设置为真 (true)。

 * 如果收到的绑定请求触发了一个新的检查被加入触发的检查队列（[7.3.1.4 节](https://www.rfc-editor.org/rfc/rfc8445.html#section-7.3.1.4)），一旦检查被发送且如果它生成了一个成功的响应，并生成了一个有效对，代理将该对的被提名标记设置为真 (true)。如果请求失败（[7.2.5.2 节](https://www.rfc-editor.org/rfc/rfc8445.html#section-7.2.5.2)），代理必须 (MUST) 将候选地址对从有效列表中移除，设置候选地址对的状态为失败 (Failed)，设置检查列表的状态为失败 (Failed)。

如果受控代理不接受来自控制代理的请求，则受控代理必须以适当的错误代码响应（例如，400）[[RFC5389](https://www.rfc-editor.org/rfc/rfc5389)] 拒绝提名请求。

一旦为数据流的一个组件设置了被提名标志，它就结束了该组件的 ICE 处理。参考 [第 8 节](https://www.rfc-editor.org/rfc/rfc8445.html#section-8)。

### 7.3.2. 精简实现的附加过程

如果受控代理接收到一个设置了 USE-CANDIDATE 属性的绑定请求，并且如果 ICE 代理接受该请求，则代理构造一个候选地址对，其本地候选地址为接收请求的传输地址，其远程候选地址是接收到的请求的源传输地址。该候选地址对被分配一个任意优先级并放入相关检查列表的有效列表中。代理将该对的被提名标志设置为真 (true)。

一旦为数据流的一个组件设置了被提名标志，它就结束了该组件的 ICE 处理。参见 [第 8 节](https://www.rfc-editor.org/rfc/rfc8445.html#section-8)。

# 8. 结束 ICE 处理

本节介绍 ICE 代理如何完成 ICE。

## 8.1. 完整实现的过程

结束 ICE 涉及由控制代理提名对和更新状态机。

### 8.1.1. 提名对

在提名之前，控制代理让连接检查继续进行，直到满足某些停止标准。之后，基于评估标准，控制代理从有效列表中的有效对中选择一对进行提名。

一旦控制代理选择了一个有效对进行提名，它就会重复产生这个有效对的连接性检查（通过将生成检查的对入队到触发检查队列中），这次使用 USE-CANDIDATE 属性（[第 7.2.5.3.4 节](https://www.rfc-editor.org/rfc/rfc8445.html#section-7.2.5.3.4) )。受控代理的过程如在 [第 7.3.1.5 节](https://www.rfc-editor.org/rfc/rfc8445.html#section-7.3.1.5) 中描述。

最终，如果提名成功，控制代理和受控代理将在数据流的每个组件的有效列表中都有一个提名对。一旦 ICE 代理将检查列表的状态设置为已完成 (Completed) （当数据流的每个组件都有一个提名对时），该对就成为该代理的选定对，并用于发送和接收数据流的该组件的数据。

如果代理无法为数据流的每个组件生成选定对，则该代理必须 (MUST) 采取适当的行动通知另一个代理，比如，通过移除流。确切的操作超出了本规范的范围。

停止连接性检查和选择一对提名的标准超出了本规范的范围。它们是本地优化的问题。唯一的要求是代理必须最终选择一个且只有一个候选地址对，并为该对生成一个设置了 USE-CANDIDATE 属性的检查。

一旦控制代理成功地提名了一个候选对（[第 7.2.5.3.4 节](https://www.rfc-editor.org/rfc/rfc8445.html#section-7.2.5.3.4)），代理不得为 ICE 会话中数据流的相同组件提名另一对。这样做需要重新启动 ICE。

不支持此规范的控制代理（如，根据 [RFC 5245](https://www.rfc-editor.org/rfc/rfc5245) 实现的）可能会提名多个候选对。这在 [RFC 5245](https://www.rfc-editor.org/rfc/rfc5245) 中被称为“积极提名”。如果控制代理提名了多个候选对，并且如果受控代理接受了多个提名请求，则代理必须生成选定对并使用具有最高优先级的对。

支持本规范的端点使用 "ice2" ICE 选项（[第 10 节](https://www.rfc-editor.org/rfc/rfc8445.html#section-10)）应该防止根据 [RFC 5245](https://www.rfc-editor.org/rfc/rfc5245) 实现的控制代理使用积极提名。

注意：在 [RFC 5245](https://www.rfc-editor.org/rfc/rfc5245) 中，“积极提名” 的使用允许代理在最终选择一对之前连续提名对，以便允许在这些对上发送数据。在本规范中，数据总是可以在任何有效对上发送，无需提名。因此，不再需要积极提名。

### 8.1.2. 更新检查列表和 ICE 状态

对于控制代理和受控代理，当数据流的组件的候选对被提名时，它可能会影响与数据流关联的检查清单中的其它对。它还可能影响清单的状态：

 * 一旦数据流的组件的候选对被提名，则与数据流关联的检查列表的状态为运行中 (Running)，ICE 代理 必须 (MUST) 从检查列表和触发检查队列中移除所有相同组件的候选对。如果对的状态为进行中 (In-Progress)，代理取消进行中 (In-Progress) 的事务。取消意味着代理将不再重新发送与连接性检查事务关联的绑定请求，不将响应的缺失看做失败，但将在事务超时时长内等待响应。

 * 一旦数据流的组件的候选对被提名，且与数据流关联的检查列表的状态为运行中 (Running)，则代理将检查列表的状态设置为完成 (Completed)。

 * 一旦数据流的组件的候选对被提名，代理 必须 (MUST) 持续响应任何它依然可能收到的用于提名对，以及用于任何与数据流关联的检查列表中的剩余候选地址对的绑定请求。如 [第 7.3.1.4 节](https://www.rfc-editor.org/rfc/rfc8445.html#section-7.3.1.4) 中所定义，当对的状态为成功 (Succeeded) 时，代理在接收到该对的绑定请求时将不再生成触发检查。

一旦检查列表集中每个检查列表的状态为已完成 (Completed)，代理将 ICE 会话的状态设置为已完成 (Completed)。

如果检查列表的状态为失败 (Failed)，ICE 无法成功完成与检查列表关联的数据流的过程。正确的行为取决于检查列表集中检查列表的状态。如果控制代理想要在没有与失败的检查列表关联的数据流的情况下继续会话，并且如果仍有一个或多个检查列表处于运行 (Running) 或已完成 (Completed)模式，则代理可以让 ICE 处理继续。代理必须 (MUST) 采取适当的措施来删除失败的数据流。如果控制代理不想继续会话并且必须 (MUST) 终止会话，则 ICE 会话的状态设置为失败。

如果检查列表集中每个检查列表的状态为失败 (Failed)，则 ICE 会话的状态设置为失败 (Failed)。除非控制代理想要在没有数据流的情况下继续会话，否则它必须 (MUST) 终止会话。

## 8.2. 精简实现的过程

当 ICE 结束时，精简 ICE 代理可以释放 ICE 未使用的主机候选地址，如 [第 8.3 节](https://www.rfc-editor.org/rfc/rfc8445.html#section-8.3) 所述。

如果对等方是完整代理，则一旦精简代理接受候选对的提名请求，精简代理就会认为该对被提名。一旦为数据流的每个组件提名了对，这些对就成为数据流的组件的选定对。一旦精简代理为所有数据流的所有组件生成了选定的对，ICE 会话状态将设置为已完成 (Completed)。

如果对等体是精简代理，则代理将本地候选地址与属于相同数据流并具有相同组件、传输协议和 IP 地址族的远程候选地址配对。对于每个数据流的每个组件，如果只有一个候选对，则将该对添加到有效列表中。如果有多对，建议 (RECOMMENDED) 代理按照 [RFC 6724](https://www.rfc-editor.org/rfc/rfc6724) [[RFC6724](https://www.rfc-editor.org/rfc/rfc6724)] 的过程选择一个对并将其添加到有效列表中。

如果所有数据流的所有组件都有一个对，则 ICE 处理的状态为已完成 (Completed)。否则，控制代理必须 (MUST) 发送一个更新的候选地址列表来协调选择不同候选对的不同代理。ICE 处理在且仅在更新的候选地址交换完成之后才完成。

## 8.3. 释放候选地址

### 8.3.1. 完整实现的过程

本节中的规则描述了代理何时可以安全地停止发送或接收未成为选定候选地址（比如，没有与选定对关联）的候选地址的检查以及何时释放候选地址。

一旦检查列表达到完成 (Completed) 状态，代理应该 (SHOULD) 再等待三秒钟，然后它可以停止响应检查或停止在所有未成为选定候选地址的那些本地候选地址上产生触发检查。一旦所有 ICE 会话都停止使用给定的本地候选地址（一个候选地址可能被多个 ICE 会话使用，例如，在分叉的场景中），代理可以释放该候选地址。三秒延迟处理使用积极提名的情况，所选对可以在 ICE 完成后快速更改。

释放服务器自反候选地址从来都不是显式的； 它是由于缺乏保活而发生的。

### 8.3.2.精简实现的过程

精简实现可以在 ICE 处理达到完成 (Completed) 状态后就立即释放所有 ICE 会话使用的那些没有变成选中候选地址的候选地址。

# 9. ICE 重启

ICE 代理可以 (MAY) 为已有的数据流重启 ICE。ICE 重启导致所有之前的数据流状态，除了代理的角色，被刷新。ICE 重启和全新的数据会话仅有的不同是在重启期间，数据可以继续使用已有的数据会话发送，而一个全新的数据会话总是需要确定角色。

以下操作只能通过使用 ICE 重启来完成（代理必须 (MUST) 使用 ICE 重启来这样做）：

 * 修改数据流的目的地址。

 * 从一个精简实现变为一个完整实现。

 * 从一个完整实现变为一个精简实现。

为了重启 ICE，代理必须 (MUST) 修改被重启的数据流的密码和用户名片段。

当 ICE 被重启时，新 ICE 会话的候选地址集可以包含一些，没有，或所有的当前 ICE 会话中所使用的候选地址。

如 [第 6.1.1 节]() 所述，代理不得将重新确定角色作为 ICE 重启的一部分，除非满足某些要求重新确定角色的标准。

# 10. ICE 选项

本节定义了一个新的 ICE 选项，"ice2"。当 ICE 代理在候选地址交换中包含了 "ice2" 时，该 ICE 选项表明它符合此规范。例如，代理不会使用 [RFC 5245](https://www.rfc-editor.org/rfc/rfc5245) 中定义的积极提名过程。此外，它将确保符合 [RFC 5245](https://www.rfc-editor.org/rfc/rfc5245) 的对等方也不使用积极提名，这是 [RFC 5245 第 14 节](https://www.rfc-editor.org/rfc/rfc5245#section-14) 对接收到未知 ICE 选项的对等方的要求。

符合本规范的代理必须 (MUST) 使用 "ice2" 选项通知对等方合规性。

注意："ice2" 选项的编码以及用于将其传送到对等方的消息是特定于协议的。SDP [[RFC4566](https://www.rfc-editor.org/rfc/rfc4566)] 的编码在 [[ICE-SIP-SDP](https://www.rfc-editor.org/rfc/rfc8445.html#ref-ICE-SIP-SDP)] 中定义。

# 11. 保活

所有的端点必须 (MUST) 为每个数据会话发送保活。这些保活用于保持数据会话的 NAT 绑定活跃的目的。保活应该 (SHOULD) 使用一种它的对等方支持的格式发送。ICE 端点允许对 UDP 流使用基于 STUN 的保活，因此，当 ICE 代理是完整的 ICE 实现并且正在与支持 ICE（精简或完整）的对等方通信时，必须 (MUST) 使用 STUN 保活。

如果在最近 Tr 秒内没有在每个用于发送数据的候选地址对上发送数据包，则代理必须 (MUST) 在该对上发送一个保活。代理应该 (SHOULD) 使用 15 秒的 Tr 值。代理可以 (MAY) 使用更大的值，但不得 (MUST NOT) 使用小于 15 秒的值。

一旦为数据流生成了选定对，则仅在这些对上发送保活。

如果数据流已经被移除了则代理必须 (MUST) 停止发送该数据流上的保活。如果 ICE 会话终止，代理必须 (MUST) 停止在所有数据流上发送保活。

代理可以 (MAY) 为 Tr 使用另一个值，例如，基于配置或网络/NAT 特性。例如，如果代理有一种动态方式来发现中间的 NAT 的绑定生命周期，它可以使用该值来确定 Tr。在更受控制的网络环境中部署 ICE 的管理员应该 (SHOULD) 将 Tr 设置为其环境中可能的最长持续时间。

当 STUN 用于保活时，使用 STUN 绑定指示 [[RFC5389](https://www.rfc-editor.org/rfc/rfc5389)]。指示不得 (MUST NOT) 使用任何认证机制。它应该 (SHOULD) 包含 FINGERPRINT 属性以帮助解复用，但它不应该 (SHOULD NOT) 包含任何其它属性。它仅用于保持 NAT 绑定活跃。使用与用于数据的相同本地和远程候选地址发送绑定指示。尽管绑定指示用于保活，代理也必须 (MUST) 准备好接收连接检查。如果收到连接性检查，则会按照 [[RFC5389](https://www.rfc-editor.org/rfc/rfc5389)] 中的讨论生成响应，但不会对 ICE 处理产生影响。

默认情况下，代理必须 (MUST) 使用 STUN 保活。个别 ICE 使用和 ICE 扩展可以 (MAY) 指定使用/扩展特定的保活。

# 12. 数据处理

## 12.1. 发送数据

在为数据流生成选定对之前，ICE 代理可以 (MAY) 在任何有效对上发送数据。

一旦为数据流生成了选定对，代理必须 (MUST) 仅在这些对上发送数据。

代理从本地候选地址的基发送数据到远程候选地址。在本地中继候选地址的情况下，数据通过基 (位于 TURN 服务器) 转发，使用[[RFC5766](https://www.rfc-editor.org/rfc/rfc5766)] 中定义的过程。

如果本地候选地址是中继候选地址，建议 (RECOMMENDED) 代理在 TURN 服务器上创建一个通向远程候选地址的通道。 这是使用 
 [[RFC5766] 第 11 节](https://www.rfc-editor.org/rfc/rfc5766#section-11) 中定义的通道创建过程来完成的。

数据流组件的选定对是：

 * 如果数据流的检查列表的状态为运行中 (Running)，并且由于 ICE 重启而没有先前为该组件选择的对，则为空

 * 如果数据流的检查列表的状态为正在运行 (Running)，并且由于 ICE 重新启动而存在该组件的先前选择的对，则等于该数据流的组件的先前选中的对。

除非代理能够为与数据流关联的每个组件生成选定的对，否则代理不得 (MUST NOT) 继续为与该数据流关联的任何组件发送数据。

### 12.1.1. 精简实现的过程

精简实现不得 (MUST NOT) 发送数据，直到它有一个有效列表，其中包含数据流的每个组件的候选地址对。一旦发生这种情况，ICE 代理可以 (MAY) 开始发送数据包。为此，它将数据发送到该对中的远程候选地址（将数据包的目标地址和端口设置为等于该远程候选地址），并将从与用于发送数据的候选对关联的基发送数据。在中继候选地址的情况下，使用 [[RFC5766](https://www.rfc-editor.org/rfc/rfc5766)] 中定义的过程，数据从代理发送并通过基（位于 TURN 服务器中）转发。

## 12.2. 接收数据

即使 ICE 代理只允许使用有效候选地址对发送数据（并且，一旦产生了选定对，仅在选定对上），ICE 实现默认情况下应该 (SHOULD) 准备好在任何最近与对等方交换候选地址中提供的候选地址上接收数据。ICE 使用可以 (MAY) 定义与此不同的规则，例如，通过定义在为数据流生成选定对之前不会发送数据。

当代理接收到特定 RTP/RTCP 数据流的 RTP 数据包具有新的源或目标 IP 地址时，建议 (RECOMMENDED) 代理重新调整其抖动缓冲区。

[RFC 3550 的第 8.2 节](https://www.rfc-editor.org/rfc/rfc3550#section-8.2) [[RFC3550](https://www.rfc-editor.org/rfc/rfc3550)] 描述了一种用于检测同步源 (SSRC) 冲突和循环的算法。这些算法部分基于看到具有相同 SSRC 的不同源传输地址。 但是，当使用 ICE 时，有时会随着数据流在候选地址之间切换而发生这种变化。作为进行媒体数据传输的 STUN 交换的结果，代理将能够确定数据流来自同一对等方。因此，如果源传输地址发生变化，但媒体数据包来自同一个对等方代理，则不得将其视为 SSRC 冲突。

# 13. 可扩展性注意事项

该规范对会话中的两个 ICE 代理如何协调以到达为数据选择的候选地址对集合做出了非常具体的选择。预计未来的规范将希望更改这些算法，无论是简单的更改，如定时器调整，还是较大的更改，如改进优先级算法。进行此类更改时，提供会话中两种代理之间的互操作性至关重要。

首先，ICE 提供了 ICE 选项概念。ICE 的每个扩展或更改都与一个 ICE 选项相关联。当代理支持此类扩展或更改时，它会向对等方代理提供 ICE 选项作为候选地址交换的一部分。

实现互操作性的复杂性之一是 ICE 依赖于在两个代理上运行的分布式算法来收敛于一组商定的候选地址对。如果两个代理运行不同的算法，则很难保证在相同的候选对上收敛。[第 8 节](https://www.rfc-editor.org/rfc/rfc8445.html#section-8) 中描述的提名过程通过将选择算法完全授权给控制代理，消除了一些紧密协作的需要，ICE 将完美地收敛，即使两个代理使用不同的候选地址对优先级算法。这种收敛性的一个关键在于触发检查，它确保被提名的候选地址对两个代理都验证了。

ICE 还可以扩展到 RTP 以外的其它数据流和 UDP 以外的传输协议。对非 RTP 数据流的 ICE 扩展需要指定它们使用的组件数量，并为它们分配组件 ID，最重要的组件 ID 从 1 开始。新传输协议的规范必须定义 ICE 处理中的各个步骤（如果有的话）与 UDP 的不同之处。

# 14. 设置 Ta 和 RTO

## 14.1. 常规

在 ICE 收集阶段（[第 5.1.1 节](https://www.rfc-editor.org/rfc/rfc8445.html#section-5.1.1)）和 ICE 执行连接检查（[第 7 节](https://www.rfc-editor.org/rfc/rfc8445.html#section-7)）时，ICE 代理会触发 STUN 和 TURN 事务。这些事务以 Ta 指示的速率进行调整，每个事务的重传间隔是根据 STUN 事务 (RTO) [[RFC5389](https://www.rfc-editor.org/rfc/rfc5389)] 的重传计时器计算的。

本节介绍如何在 ICE 收集阶段以及 ICE 执行连接性检查时计算 Ta 和 RTO 值。

注意：以前，在 [RFC 5245](https://www.rfc-editor.org/rfc/rfc5245) 中，为计算 Ta 和 RTO 定义了不同的公式，具体取决于 ICE 是否用于实时数据流（例如 RTP）。

下面的公式导致代理将在执行重传之前为每个连接检查发送其第一个数据包的行为。这可以在 RTO（表示重传间隔）的公式中看出。这些公式与要执行的检查次数 N 成比例。因此，ICE 保持了一个很好的恒定速率，但它对数据包丢失变得更加敏感。任何连通性检查的第一个单个数据包丢失可能会导致该对需要很长时间才能验证，相反，较低优先级的检查（但没有数据包丢失的检查）更有可能先完成。这导致 ICE 表现不佳，选择较低优先级的对而不是较高优先级的对。

## 14.2. Ta

ICE 代理应该 (SHOULD) 使用默认的 Ta 值，50 毫秒，但可以 (MAY) 根据相关数据的特性使用另一个值。

如果代理想要使用默认值以外的 Ta 值，代理必须 (MUST) 在 ICE 会话建立期间向其对等方指示建议的值。两个代理都必须 (MUST) 使用建议值中的较高值。如果代理没有建议值，则在比较哪个值更高时，该代理使用默认值。

无论为每个代理选择的 Ta 值如何，来自所有代理的所有事务的组合（如果给定的实现运行多个并发代理）不得 (MUST NOT) 超过每 5 毫秒发送一次（就好像有一个全局 Ta 值用于调整所有代理一样）。有关 ICE 使用 5 ms 值的背景信息，请参见 [附录 B.1](https://www.rfc-editor.org/rfc/rfc8445.html#appendix-B.1)。

注：[附录 C](https://www.rfc-editor.org/rfc/rfc8445.html#appendix-C) 显示了使用不同 Ta 值的所需带宽示例。

## 14.2. RTO

在 ICE 收集阶段，ICE 代理应该 (SHOULD) 使用以下公式计算 RTO 值：

     RTO = MAX (500ms, Ta * (Num-Of-Cands))
     Num-Of-Cands: 服务器自反和中继候选地址的个数

对于连接性检查，代理应该使用以下公式计算RTO值：

     RTO = MAX (500ms, Ta * N * (Num-Waiting + Num-In-Progress))

     N：将被执行的连接检查的总个数。

     Num-Waiting：检查列表集合中处于等待 (Waiting) 状态的检查的个数。

     Num-In-Progress: 检查列表集合中处于进行中 (In-Progress) 状态的检查的个数。

     请注意，随着处于等待 (Waiting) 和进行中 (In-Progress) 状态的检查数量发生变化，每个事务的 RTO 将有所不同。

代理可以 (MAY) 使用上述以外的其它机制计算 RTO 值。 代理不得 (MUST NOT) 使用小于 500 毫秒的 RTO 值。

# 15. 例子

本节展示了两个 ICE 示例：一个使用 IPv4 地址，一个使用 IPv6 地址。

为了便于理解，使用具有助记名称的变量列出传输地址。名称的格式是 entity-type-seqno："entity" 是指传输地址所在 IP 地址所属的实体，是 "L"、"R"、"STUN" 或 "NAT" 之一。对于公共的传输地址，类型是 "PUB"，对于私有的传输地址，类型是 "PRIV" [[RFC1918](https://www.rfc-editor.org/rfc/rfc1918)]。最后，seq-no 是一个序列号，对于特定实体上相同类型的每个传输地址，它是不同的。每个变量都有一个 IP 地址和端口，分别用 varname.IP 和 varname.PORT 表示，其中 varname 是变量的名称。

在呼叫流程本身中，STUN 消息使用几个属性进行注释。"S=" 属性表示消息的源传输地址。 "D=" 属性表示消息的目的传输地址。"MA=" 属性用于 STUN 绑定 (Binding) 响应消息，并指映射地址。"USE-CAND" 意味着存在 USE-CANDIDATE 属性。

呼叫流程示例省略了 STUN 身份验证操作，并专注于两个完整实现之间的单个数据流。

## 15.1. 使用 IPv4 地址的例子

下面的示例使用图 7 中所示的拓扑。
```
                                  +-------+
                                  |STUN   |
                                  |Server |
                                  +-------+
                                      |
                           +---------------------+
                           |                     |
                           |      Internet       |
                           |                     |
                           +---------------------+
                             |                |
                             |                |
                      +---------+             |
                      |   NAT   |             |
                      +---------+             |
                           |                  |
                           |                  |
                        +-----+            +-----+
                        |  L  |            |  R  |
                        +-----+            +-----+
```
图 7：示例拓扑

在这个例子中，ICE 代理 L 和 R 是完整 ICE 实现。两个代理都有一个 IPv4 地址，并且都配置了相同的 STUN 服务器。NAT 具有与端点无关的映射属性和与地址相关的过滤属性。***IP 限制型 NAT？*** ICE 代理，STUN 服务器，和 NAT 的 IP 地址如下：
```
   ENTITY                   IP Address  Mnemonic name
   --------------------------------------------------
   ICE Agent L:             10.0.1.1    L-PRIV-1
   ICE Agent R:             192.0.2.1   R-PUB-1
   STUN Server:             192.0.2.2   STUN-PUB-1
   NAT (Public):            192.0.2.3   NAT-PUB-1
```

```
             L             NAT           STUN             R
             |STUN alloc.   |              |              |
             |(1) STUN Req  |              |              |
             |S=$L-PRIV-1   |              |              |
             |D=$STUN-PUB-1 |              |              |
             |------------->|              |              |
             |              |(2) STUN Req  |              |
             |              |S=$NAT-PUB-1  |              |
             |              |D=$STUN-PUB-1 |              |
             |              |------------->|              |
             |              |(3) STUN Res  |              |
             |              |S=$STUN-PUB-1 |              |
             |              |D=$NAT-PUB-1  |              |
             |              |MA=$NAT-PUB-1 |              |
             |              |<-------------|              |
             |(4) STUN Res  |              |              |
             |S=$STUN-PUB-1 |              |              |
             |D=$L-PRIV-1   |              |              |
             |MA=$NAT-PUB-1 |              |              |
             |<-------------|              |              |
             |(5) L's Candidate Information|              |
             |------------------------------------------->|
             |              |              |              | STUN
             |              |              |              | alloc.
             |              |              |(6) STUN Req  |
             |              |              |S=$R-PUB-1    |
             |              |              |D=$STUN-PUB-1 |
             |              |              |<-------------|
             |              |              |(7) STUN Res  |
             |              |              |S=$STUN-PUB-1 |
             |              |              |D=$R-PUB-1    |
             |              |              |MA=$R-PUB-1   |
             |              |              |------------->|
             |(8) R's Candidate Information|              |
             |<-------------------------------------------|
             |              |         (9) Bind Req        |Begin
             |              |         S=$R-PUB-1          |Connectivity
             |              |         D=$L-PRIV-1         |Checks
             |              |         <-------------------|
             |              |         Dropped             |
             |(10) Bind Req |              |              |
             |S=$L-PRIV-1   |              |              |
             |D=$R-PUB-1    |              |              |
             |------------->|              |              |
             |              |(11) Bind Req |              |
             |              |S=$NAT-PUB-1  |              |
             |              |D=$R-PUB-1    |              |
             |              |---------------------------->|
             |              |(12) Bind Res |              |
             |              |S=$R-PUB-1    |              |
             |              |D=$NAT-PUB-1  |              |
             |              |MA=$NAT-PUB-1 |              |
             |              |<----------------------------|
             |(13) Bind Res |              |              |
             |S=$R-PUB-1    |              |              |
             |D=$L-PRIV-1   |              |              |
             |MA=$NAT-PUB-1 |              |              |
             |<-------------|              |              |
             |Data          |              |              |
             |===========================================>|
             |              |              |              |
             |              |(14) Bind Req |              |
             |              |S=$R-PUB-1    |              |
             |              |D=$NAT-PUB-1  |              |
             |              |<----------------------------|
             |(15) Bind Req |              |              |
             |S=$R-PUB-1    |              |              |
             |D=$L-PRIV-1   |              |              |
             |<-------------|              |              |
             |(16) Bind Res |              |              |
             |S=$L-PRIV-1   |              |              |
             |D=$R-PUB-1    |              |              |
             |MA=$R-PUB-1   |              |              |
             |------------->|              |              |
             |              |(17) Bind Res |              |
             |              |S=$NAT-PUB-1  |              |
             |              |D=$R-PUB-1    |              |
             |              |MA=$R-PUB-1   |              |
             |              |---------------------------->|
             |Data          |              |              |
             |<===========================================|
             |              |              |              |
                                .......
             |              |              |              |
             |(18) Bind Req |              |              |
             |S=$L-PRIV-1   |              |              |
             |D=$R-PUB-1    |              |              |
             |USE-CAND      |              |              |
             |------------->|              |              |
             |              |(19) Bind Req |              |
             |              |S=$NAT-PUB-1  |              |
             |              |D=$R-PUB-1    |              |
             |              |USE-CAND      |              |
             |              |---------------------------->|
             |              |(20) Bind Res |              |
             |              |S=$R-PUB-1    |              |
             |              |D=$NAT-PUB-1  |              |
             |              |MA=$NAT-PUB-1 |              |
             |              |<----------------------------|
             |(21) Bind Res |              |              |
             |S=$R-PUB-1    |              |              |
             |D=$L-PRIV-1   |              |              |
             |MA=$NAT-PUB-1 |              |              |
             |<-------------|              |              |
             |              |              |              |
```
图 8：示例流程

消息 1 - 4：代理 L 从它的本地 IP 地址收集到一个主机候选地址，并从它向 STUN 服务器发送一个 STUN 绑定 (Binding) 请求。请求创建一个 NAT 绑定。绑定的 NAT 公网 IP 地址变为代理 L 的服务器自反候选地址。

消息 5：代理 L 把它的本地候选地址信息发送给代理 R，使用与 ICE 应用关联的信令协议。

消息 6 - 7：代理 R 从它的本地 IP 地址收集到一个主机候选地址，并从它向 STUN 服务器发送一个 STUN 绑定 (Binding) 请求。由于代理 R 不在 NAT 后面，R 的服务器自反候选地址将与主机候选地址相同。

消息 8：代理 R 将它的本地候选地址信息发送给代理 L，使用与 ICE 应用关联的信令协议。

由于两个代理都是完整 ICE 实现，则发起代理（代理 L）成为控制代理。

代理 L 和 R 都将候选地址配对。两个代理最初都有两对。但是，代理 L 将剪除包含其服务器自反候选地址的对，从而仅剩一个 (L1)。在代理 L，这个对有一个本地候选地址 $L_PRIV_1 和一个远程候选地址 $R_PUB_1。在代理 R，有两个对。最高优先级的对 (R1) 具有一个本地候选地址 $R_PUB_1，和一个远程候选地址 $L_PRIV_1，第二个对 (R2) 具有一个本地候选地址 $R_PUB_1，和一个远程候选地址 $NAT_PUB_1。这些对如下所示（候选地址对的号仅供参考）：
```
                            Pairs
   ENTITY                   Local         Remote     Pair #     Valid
   ------------------------------------------------------------------
   ICE Agent L:             L_PRIV_1      R_PUB_1       L1

   ICE Agent R:             R_PUB_1       L_PRIV_1      R1
                            R_PUB_1       NAT_PUB_1     R2
```

消息 9：代理 R 为候选地址对 #2 发起一个连接检查。由于该对的远程候选地址是代理 L 的私有地址，检查将不会成功，由于请求无法从 R 路由到 L，请求将被网络丢弃。

消息 10 - 13：代理 L 为候选地址对 L1 发起一个连接检查。检查成功，且 L 创建一个新的对 (L2)。新的对的本地候选地址是 $NAT_PUB_1，远程候选地址是 $R_PUB_1。候选地址对 (L2) 被添加进代理 L 的有效列表。如果需要，代理 L 现在可以在该对 (L2) 上发送和接收数据。
```
                            Pairs
   ENTITY                   Local         Remote     Pair #     Valid
   ------------------------------------------------------------------
   ICE Agent L:             L_PRIV_1      R_PUB_1       L1
                            NAT_PUB_1     R_PUB_1       L2        X

   ICE Agent R:             R_PUB_1       L_PRIV_1      R1
                            R_PUB_1       NAT_PUB_1     R2
```

消息 14 - 17：当代理 R 收到代理 L 的绑定 (Binding) 请求（消息 11）时，它将启动触发的连接检查。该对匹配代理 R 的现有对之一 (R2)。检查成功，该对 (R2) 被添加到代理 R 的有效列表中。如果需要，代理 R 现在可以在对 (R2) 上发送和接收数据。
```
                            Pairs
   ENTITY                   Local         Remote     Pair #     Valid
   ------------------------------------------------------------------
   ICE Agent L:             L_PRIV_1      R_PUB_1       L1
                            NAT_PUB_1     R_PUB_1       L2        X

   ICE Agent R:             R_PUB_1       L_PRIV_1      R1
                            R_PUB_1       NAT_PUB_1     R2        X
```

消息 18 - 21：在某个时刻，控制代理（代理 L）决定在有效列表中提名一个对 (L2)。它在该对 (L2) 上执行连接检查，并在绑定请求中包含 USE-CANDIDATE 属性。当检查成功时，代理 L 将该对 (L2) 的提名标志值设置为 'true'，而代理 R 将匹配对 (R2) 的提名标志值设置为 'true'。

由于没有更多的组件与流相关联，因此提名的对成为选定的对。因此，对此流的处理将进入完成 (Completed) 状态。 ICE 过程也进入完成 (Completed) 状态。

## 15.2. 使用 IPv6 地址的例子

下面的示例使用图 9 所示的拓扑。
```
                                +-------+
                                |STUN   |
                                |Server |
                                +-------+
                                    |
                         +---------------------+
                         |                     |
                         |      Internet       |
                         |                     |
                         +---------------------+
                            |                |
                            |                |
                            |                |
                            |                |
                            |                |
                            |                |
                            |                |
                         +-----+          +-----+
                         |  L  |          |  R  |
                         +-----+          +-----+
```
图 9：示例拓扑

在这个示例中，ICE 代理 L 和 R 都是完整的 ICE 实现。两个代理都有一个 IPv6 地址，并且都配置了相同的 STUN 服务器。ICE 代理和 STUN 服务器的 IP 地址如下所示：
```
   ENTITY                   IP Address  mnemonic name
   --------------------------------------------------
   ICE Agent L:             2001:db8::3   L-PUB-1
   ICE Agent R:             2001:db8::5   R-PUB-1
   STUN Server:             2001:db8::9   STUN-PUB-1
```

```
             L                           STUN             R
             |STUN alloc.                  |              |
             |(1) STUN Req                 |              |
             |S=$L-PUB-1                   |              |
             |D=$STUN-PUB-1                |              |
             |---------------------------->|              |
             |(2) STUN Res                 |              |
             | S=$STUN-PUB-1               |              |
             | D=$L-PUB-1                  |              |
             | MA=$L-PUB-1                 |              |
             |<----------------------------|              |
             |(3) L's Candidate Information|              |
             |------------------------------------------->|
             |                             |              | STUN
             |                             |              | alloc.
             |                             |(4) STUN Req  |
             |                             |S=$R-PUB-1    |
             |                             |D=$STUN-PUB-1 |
             |                             |<-------------|
             |                             |(5) STUN Res  |
             |                             |S=$STUN-PUB-1 |
             |                             |D=$R-PUB-1    |
             |                             |MA=$R-PUB-1   |
             |                             |------------->|
             |(6) R's Candidate Information|              |
             |<-------------------------------------------|
             |(7) Bind Req                 |              |
             |S=$L-PUB-1                   |              |
             |D=$R-PUB-1                   |              |
             |------------------------------------------->|
             |(8) Bind Res                 |              |
             |S=$R-PUB-1                   |              |
             |D=$L-PUB-1                   |              |
             |MA=$L-PUB-1                  |              |
             |<-------------------------------------------|
             |Data                         |              |
             |===========================================>|
             |                             |              |
             |(9) Bind Req                 |              |
             |S=$R-PUB-1                   |              |
             |D=$L-PUB-1                   |              |
             |<-------------------------------------------|
             |(10) Bind Res                |              |
             |S=$L-PUB-1                   |              |
             |D=$R-PUB-1                   |              |
             |MA=$R-PUB-1                  |              |
             |------------------------------------------->|
             |Data                         |              |
             |<===========================================|
             |                             |              |
                                .......
             |                             |              |
             |(11) Bind Req                |              |
             |S=$L-PUB-1                   |              |
             |D=$R-PUB-1                   |              |
             |USE-CAND                     |              |
             |------------------------------------------->|
             |(12) Bind Res                |              |
             |S=$R-PUB-1                   |              |
             |D=$L-PUB-1                   |              |
             |MA=$L-PUB-1                  |              |
             |<-------------------------------------------|
             |              |              |              |
```
图 10：示例流程

消息 1 - 2：代理 L 从其本地 IP 地址收集主机候选地址，并从其向 STUN 服务器发送 STUN 绑定请求。 由于代理 L 不在 NAT 后面，因此 L 的服务器自反候选地址将与主机候选地址相同。

消息 3：代理 L 使用与 ICE 应用相关的信令协议将其本地候选地址信息发送给代理 R。

消息 4 - 5：代理 R 从其本地 IP 地址收集主机候选地址，并从其向 STUN 服务器发送 STUN 绑定请求。 由于代理 R 不在 NAT 后面，因此 R 的服务器自反候选地址将与主机候选地址相同。

消息 6：代理 R 使用与 ICE 应用相关的信令协议将其本地候选地址信息发送给代理 L。

由于两个代理都是完整 ICE 实现，则发起代理（代理 L）成为控制代理。

代理 L 和 R 都将候选地址配对。两个代理最初各有一个对。 在代理 L 处，对 (L1) 有一个本地候选地址 $L_PUB_1 和一个远程候选地址 $R_PUB_1。 在代理 R，对 (R1) 有一个本地候选地址 $R_PUB_1 和一个远程候选地址 $L_PUB_1。 候选地址对如下所示（候选地址对编号仅供参考）：
```
                            Pairs
   ENTITY                   Local         Remote     Pair #     Valid
   ------------------------------------------------------------------
   ICE Agent L:             L_PUB_1       R_PUB_1       L1

   ICE Agent R:             R_PUB_1       L_PUB_1       R1
```

消息 7 - 8：代理 L 启动对候选地址对 L1 的连接检查。 检查成功，候选地址对 (L1) 被添加到代理 L 的有效列表中。代理 L 现在可以根据需要在候选地址对 (L1) 上发送和接收数据。

```
                            Pairs
   ENTITY                   Local         Remote     Pair #     Valid
   ------------------------------------------------------------------
   ICE Agent L:             L_PUB_1       R_PUB_1       L1         X

   ICE Agent R:             R_PUB_1       L_PUB_1       R1
```

消息 9 - 10：当代理 R 收到代理 L 的绑定请求（消息 7）时，它将启动触发的连接检查。该对匹配代理 R 的现有对 (R1)。 检查成功，对 (R1) 被添加到代理 R 的有效列表中。代理 R 现在可以根据需要在对 (R1) 上发送和接收数据。

```
                            Pairs
   ENTITY                   Local         Remote     Pair #     Valid
   ------------------------------------------------------------------
   ICE Agent L:             L_PUB_1       R_PUB_1       L1         X

   ICE Agent R:             R_PUB_1       L_PUB_1       R1         X
```

消息 11 - 12：在某个时刻，控制代理（代理 L）决定在有效列表中提名一个对 (L1)。 它在对 (L1) 上执行连接检查，并在绑定请求中包含 USE-CANDIDATE 属性。 当检查成功时，代理 L 将对 (L1) 的提名标志值设置为 'true'，代理 R 将匹配的对 (R1) 的提名标志值设置为 'true'。

由于没有更多的组件与流相关联，因此提名的对成为选定的对。因此，对此流的处理将进入完成 (Completed) 状态。 ICE 过程也进入完成 (Completed) 状态。

# 16. STUN 扩展

## 16.1. 属性

该规范定义了四个 STUN 属性：PRIORITY、USE-CANDIDATE、ICE-CONTROLLED 和 ICE-CONTROLLING。

PRIORITY 属性指示与对等自反候选地址相关联的优先级，如果此检查将发现一个。它是一个 32 位无符号整数，属性值为 0x0024。

USE-CANDIDATE 属性指示由该检查产生的候选地址对将用于数据传输。该属性没有内容（属性的 Length 字段为零）；它用作一个标记。 它的属性值为 0x0025。

ICE-CONTROLLED 属性存在于绑定请求中。该属性表明客户端认为它当前处于受控角色。该属性的内容是一个网络字节序的 64 位无符号整数，其中包含一个随机数。该数字用于解决角色冲突，当它被称为 “决胜局值” 时。ICE 代理必须 (MUST) 对 ICE 会话中的所有流的所有绑定请求使用相同的数字，除非它收到 487 响应，在这种情况下它必须 (MUST) 更改数字（[第 7.2.5.1 节](https://www.rfc-editor.org/rfc/rfc8445.html#section-7.2.5.1)）。当 ICE 重新启动时，代理可以 (MAY) 更改数字。

ICE-CONTROLLING 属性存在于绑定请求中。 该属性表明客户端认为它当前处于控制角色。 该属性的内容是一个网络字节序的 64 位无符号整数，其中包含一个随机数。至于 ICE-CONTROLLED 属性，数字用于解决角色冲突。ICE 代理必须 (MUST) 对 ICE 会话中的所有流的所有绑定请求使用相同的数字，除非它收到 487 响应，在这种情况下它必须 (MUST) 更改数字（[第 7.2.5.1 节](https://www.rfc-editor.org/rfc/rfc8445.html#section-7.2.5.1)）。当 ICE 重新启动时，代理可以 (MAY) 更改数字。

## 16.2. 新的错误响应码

该规范定义了一个错误响应码：

487 (角色冲突)：绑定请求包含 ICE-CONTROLLING 或 ICE-CONTROLLED 属性，指示与服务器冲突的 ICE 角色。远程服务器比较客户端和服务器的 tiebreaker 值，确定客户端需要切换角色。

# 17. 操作注意事项

本节讨论与运营商运营网络相关的问题，其中 ICE 将被端点使用。

## 17.1. NAT 和防火墙类型

ICE 旨在与现有的 NAT 和防火墙设备配合使用。 因此，无需更换或重新配置现有的防火墙和 NAT 设备以方便 ICE 的部署。事实上，ICE 的开发目的是部署在 IP 语音 (VoIP) 运营商无法控制 IP 网络基础设施（包括防火墙和 NAT）的环境中。

也就是说，ICE 在 NAT 设备 “行为” 兼容的环境中工作得最好，满足 [[RFC4787](https://www.rfc-editor.org/rfc/rfc4787)] 和 [[RFC5382](https://www.rfc-editor.org/rfc/rfc5382)] 中定义的建议。在具有行为兼容 NAT 的网络中，ICE 无需 TURN 服务器即可工作，从而提高语音质量、减少呼叫建立时间并降低对网络运营商的带宽需求。

## 17.2. 带宽要求

ICE 的部署可能与运营商需要考虑的可用网络容量有多种交互。

### 17.2.1. STUN 和 TURN 服务器容量规划

首先，ICE 使用 TURN 和 STUN 服务器，这些服务器通常位于数据中心。STUN 服务器需要的带宽相对较少。对于每个数据流的每个组件，从每个客户端到 STUN 服务器都会有一个或多个 STUN 事务。在基本的纯语音 IPv4 VoIP 部署中，每个呼叫将有四个事务（一个用于 RTP，一个用于 RTCP，用于呼叫者和被呼叫者）。每个事务都是一个请求和一个响应，前者为 20 个字节长，后者为 28 个字节。

因此，如果一个系统有 N 个用户，每个用户在繁忙的一小时中拨打 4 个电话，这将需要 N*1.7 bps（(20 + 28) * 4 * 4 / 3600 * 8）。对于一百万用户，这是 1.7 Mbps，一个非常小数字（相对来说）。

TURN 流量更大。除了实际数据的流量之外，TURN 服务器将看到等于 STUN 量的流量（实际上，如果部署了 TURN 服务器，则不需要单独的 STUN 服务器）。需要 TURN 进行数据中继的呼叫量高度依赖于网络拓扑，并且会随着时间而变化。在具有 100% 行为兼容 NAT 的网络中，它正好为零。

上述规划考虑在多媒体场景（例如，音频和视频会议）以及会话参与者数量增加时变得更加重要。

### 17.2.2. 收集和连接检查

收集候选地址和执行连接检查的过程可能会占用大量带宽。ICE 旨在为这两个过程平滑节奏。收集和连接检查阶段旨在以与 ICE 流程结束后数据流量本身消耗的带宽大致相同的带宽生成流量。这样做是为了确保如果网络设计为支持某种类型的通信流量（语音、视频或仅文本），它将有足够的能力支持 ICE 检查该数据。一旦 ICE 结束，后续的 ICE keepalives 将在稍后导致总带宽利用率的边际增加；但是，这通常是极小的增加。

由于收集和检查阶段导致的拥塞已被证明是未使用调步的部署中的一个问题。通常情况下，当端点以最快的速度发送检查而淹没了网络时，访问链路会变得拥塞。因此，网络运营商需要确保它们的 ICE 实现支持调步功能。虽然这种调步确实增加了呼叫建立时间，但它使 ICE 网络友好且更易于部署。

### 17.2.3. 保活

STUN 保活（以 STUN 绑定指示的形式）在数据会话的中间发送。但是，它们仅在没有实际数据流量的情况下发送。在具有连续媒体且不使用语音活动检测 (VAD) 的部署中，或者在与短间隔（最多 1 秒）舒适噪声一起使用的 VAD 的部署中，从不使用保活，并且不会增加带宽使用。当 VAD 在没有舒适噪音的情况下使用时，将在静音期间发送保活。这涉及每 15 - 20 秒发送一个数据包，远远少于有语音时每 20-30 毫秒发送的数据包。因此，保活对容量规划没有任何实际影响。

## 17.3. ICE 和 ICE-Lite

混合使用 ICE 和 ICE-lite 的部署可以相互操作。它们被明确设计为这样做。

但是，ICE-lite 只能部署在有限的用例中。[附录 A](https://www.rfc-editor.org/rfc/rfc8445.html#appendix-A) 中记录了这些用例以及相关注意事项。

## 17.4. 故障排除和性能管理

ICE 利用端到端连接检查并将大部分处理放在端点中。这给网络运营商带来了挑战——它们如何对 ICE 部署进行故障排除？ 它们怎么知道 ICE 的表现如何？

ICE 具有帮助处理这些问题的内置功能。信令服务器，通常部署在网络运营商的数据中心，将看到携带 ICE 参数的候选地址交换的内容。这些参数包括每个候选地址的类型（主机，服务器自反，或中继），以及它们相关的地址。一旦 ICE 处理已完成，更新的候选地址交换将发生，通知选中的地址（以及它的类型）。执行此更新的通知的目的是让网络设备（例如附加到信令的诊断工具）了解 ICE 处理的结果。

因此，通过信令服务器生成的日志，网络运营商可以观察每个呼叫使用了什么类型的候选地址，以及 ICE 选择了什么地址。这是有助于评估 ICE 表现的主要信息。

## 17.5. 端点配置

ICE 依赖于配置到端点中的几条数据。此配置数据包括计时器、TURN 服务器的凭据以及 STUN 和 TURN 服务器的主机名。ICE 本身不提供这种配置的机制。相反，假定此信息附加到用于配置端点中所有其它参数的任何机制。对于 SIP 电话，已经定义了如配置框架 [[RFC6080](https://www.rfc-editor.org/rfc/rfc6080)] 这样的标准解决方案。

原文：[Interactive Connectivity Establishment (ICE): A Protocol for Network Address Translator (NAT) Traversal](https://www.rfc-editor.org/rfc/rfc8445.html)
