### 摘要

本文档为基于 UDP 的通信描述了一种用于网络地址转换 (NAT) 穿越的协议。这个协议被称为 交互式连接建立 (ICE)。ICE 利用 NAT 的会话穿越实用程序 (STUN) 协议及其扩展，使用中继的 NAT 穿越 (TURN) 协议。

本文档废止了 [RFC 5245](https://www.rfc-editor.org/rfc/rfc5245)。

### 备忘录状态

这是一个互联网标准跟踪文件。本文档是 IETF (Internet Engineering Task Force) 的产品。它代表了 IETF 社区的共识。它已接受公众审查，并已获互联网工程指导小组 (IESG) 批准出版。有关互联网标准的进一步信息，请参阅 [RFC 7841第2节](https://www.rfc-editor.org/rfc/rfc7841#section-2)。

有关此文档的当前状态、任何勘误表以及如何对其提供反馈的信息，可在以下网址获得 [https://www.rfc-editor.org/info/rfc8445](https://www.rfc-editor.org/info/rfc8445)。

### 版权声明

版权所有 (c) 2018 IETF 信托和确认为文件作者的人。保留所有权利。

本文档受 [BCP 78](https://www.rfc-editor.org/bcp/bcp78) 和自本文档发布之日起生效的 IETF 信托关于 IETF 文件的法律规定 (https://trustee.ietf.org/license-info) 的约束。请仔细审阅这些文件，因为它们描述了您在此文档方面的权利和限制。从本文档中提取的代码组件必须包含信托法律规定的第 4.e 节中描述的简化 BSD 许可证文本，且如简化 BSD 许可证所述，不为这些代码提供任何担保。

本文档可能包含在 2008 年 11 月 10 日前发布或公开的来自 IETF 文档或 IETF 贡献的材料。控制这些材料的某些版权的人可能没有授予 IETF Trust 允许在 IETF 标准过程之外修改这些材料的权利。没有从控制这些材料的版权的人那里获得足够的许可，本文档不得在 IETF 标准过程之外被修改，也不得在 IETF 标准过程之外被创作出其衍生作品，除非将其格式化为 RFC 或将其翻译成英语以外的语言。

[TOC]

### 1. 简介

在对等体之间建立通信会话的协议通常涉及到为数据源和接收器交换 IP 地址和端口。然而，当通过网络地址转换 (NATs) [[RFC3235](https://www.rfc-editor.org/rfc/rfc3235)] 协议进行操作时，这就遇到了挑战。这些协议寻求在参与者之间直接创建数据流，因此它们之间不存在应用层中介。这样做是为了减少数据延迟、减少包丢失，并降低部署应用程序的运维成本。然而，这在通过 NATs 时很难实现。对其原因的全面处理超出了本规范的范围。

已经定义了许多解决方案来允许这些协议通过 NATs 进行操作。其中包括应用层网关 (ALGs)、中箱控制协议 [[RFC3303](https://www.rfc-editor.org/rfc/rfc3303)]、最初的简单 UDP 穿越 NAT (STUN) 规范[[RFC3489](https://www.rfc-editor.org/rfc/rfc3489)]（注意 [RFC 3489](https://www.rfc-editor.org/rfc/rfc3489) 已经由 [RFC 5389](https://www.rfc-editor.org/rfc/rfc5389) 废止），和 Realm Specific IP [[RFC3102](https://www.rfc-editor.org/rfc/rfc3102)] [[RFC3103](https://www.rfc-editor.org/rfc/rfc3103)]，以及使它们工作所需的会话描述扩展，例如 RTCP [[RFC3605](https://www.rfc-editor.org/rfc/rfc3605)] 的 SDP (会话描述协议) 属性 [[RFC4566](https://www.rfc-editor.org/rfc/rfc4566)]。不幸的是，这些技术都有优点和缺点，使得它们在某些网络拓扑中是最佳的，但在其它拓扑中则是糟糕的选择。结果是，管理员和实现者对部署解决方案的网络拓扑做出了假设。这给系统带来了复杂性和脆弱性。

该规范将交互连接建立 (ICE) 定义为一种用于基于 UDP 的数据流的 NAT 穿越技术 ( 尽管 ICE 已经被扩展到处理其它传输协议，如 TCP [[RFC6544](https://www.rfc-editor.org/rfc/rfc6544)])。ICE 通过交换多个 IP 地址和端口来工作，然后通过点对点连接检查来测试这些地址和端口的连通性。IP 地址和端口的交换是通过特定的 ICE 用法的机制实现的 (比如，在 Offer/Answer 交换中)，并且使用 STUN [[RFC5389](https://www.rfc-editor.org/rfc/rfc5389)] 执行连接性检查。ICE 也使用了 使用中继穿越 NAT (TURN) [[RFC5766](https://www.rfc-editor.org/rfc/rfc5766)] 协议， STUN 的一个扩展。因为 ICE 为每个媒体流交换多个 IP 地址和端口，它还允许多家园和双栈主机的地址选择。因此，[RFC 5245](https://www.rfc-editor.org/rfc/rfc5245) [RFC5245] 摒弃了之前在 [RFC 4091](https://www.rfc-editor.org/rfc/rfc4091) [[RFC4091](https://www.rfc-editor.org/rfc/rfc4091)] 和 [RFC 4092](https://www.rfc-editor.org/rfc/rfc4092) [[RFC4092](https://www.rfc-editor.org/rfc/rfc4092)] 中定义的解决方案。

[附录 B](https://www.rfc-editor.org/rfc/rfc8445.html#appendix-B) 提供了设计 ICE 时所做的设计决策的背景信息和动机。

### 2. ICE 概述

在典型的 ICE 部署中，有两个需要通信的端点 (ICE代理)。请注意，ICE 并不打算用于信令协议的 NAT 穿越，这被认为是通过另一种机制提供的。ICE 假设代理能够在彼此之间建立信令连接。

最初，代理不知道自己的拓扑。具体来说，代理可能在 NATs (或多层 NATs) 后面，也可能不在后面。ICE 允许代理发现关于其拓扑的足够信息，从而可能找到一条或多条路径，它们可以通过这些路径建立数据会话。

图 1 显示了一个典型的 ICE 部署。代理被标记为 L 和 R。L 和 R 都在各自的 NATs 后面，虽然它们可能不知道。NAT 的类型和属性也是未知的。L 和 R 能够进行一个候选交换过程，其目的是在 L 和 R 之间建立一个数据会话。通常，这种交换将通过一个信令服务器进行（比如，一个SIP 代理）。除了代理、信令服务器和 NATs 外，ICE 通常与网络中的 STUN 或 TURN 服务器一起使用。每个代理可以有自己的 STUN 或 TURN 服务器，也可以是相同的。
```
                               +---------+
             +--------+        |Signaling|         +--------+
             | STUN   |        |Server   |         | STUN   |
             | Server |        +---------+         | Server |
             +--------+       /           \        +--------+
                             /             \
                            /               \
                           / <- Signaling -> \
                          /                   \
                   +--------+               +--------+
                   |  NAT   |               |  NAT   |
                   +--------+               +--------+
                      /                             \
                     /                               \
                 +-------+                       +-------+
                 | Agent |                       | Agent |
                 |   L   |                       |   R   |
                 +-------+                       +-------+
```
图 1：ICE 部署场景

ICE 背后的基本思想如下：每个代理都有各种各样的候选传输地址 (特定传输协议的 IP 地址和端口的组合，在本规范中总是 UDP)，它可以用来与其它代理通信。这些可能包括：

 * 直接连接的网络接口上的一种传输地址
 * NAT 的经过转换的公网传输地址 ( “服务器自反” 地址)
 * 从 TURN 服务器分配的传输地址 ( “中继地址” )

可能地，L 的任何候选传输地址都可以用来与 R 的任何候选传输地址通信。然而，在实践中，许多组合是行不通的。例如，如果 L 和 R 都在 NATs 后面，则它们直接连接的接口地址不太可能直接通信 (这就是为什么需要ICE !)。ICE 的目的是发现哪对地址是可行的。ICE 的方法是系统地尝试所有可能的配对 ( 按仔细排序的顺序 )，直到找到一个或多个可行的配对。

#### 2.1 收集候选地址

为了执行 ICE，ICE 代理识别并收集一个或多个候选地址。一个候选对象有一个传输地址 —— 一个特定传输协议的 IP 地址和端口的组合 ( 这里只使用 UDP)。有不同类型的候选地址；一些来自物理或逻辑网络接口，其它是通过 STUN 和 TURN 发现的。

第一类候选地址是直接从本地接口获得的传输地址。这样的候选地址被称为“主机候选地址”。本地接口可以是以太网或 Wi-Fi，也可以是通过隧道机制获得的接口，如虚拟专用网络 (VPN) 或移动 IP (MIP)。在所有情况下，这样的网络接口对代理来说都是一个本地接口，可以从这个接口分配端口 ( 以及候选端口 )。

接下来，代理使用 STUN 或 TURN 获得额外的候选地址。有两种类型：在 NAT 的公网端转换的地址 (服务器自反候选地址) 和在 TURN 服务器上的地址 (中继候选地址)。当使用 TURN 服务器时，这两种类型的候选地址都从 TURN 服务器获得。如果只使用 STUN 服务器，则只从它们获得服务器自反候选地址。这些候选地址与主机候选地址的关系如图 2 所示。在该图中，两种类型的候选地址都是使用 TURN 发现的。图中 X:s 表示 IP 地址 X 和 UDP 端口 x。
```
                      To Internet

                          |
                          |
                          |  /------------  Relayed
                      Y:y | /               Address
                      +--------+
                      |        |
                      |  TURN  |
                      | Server |
                      |        |
                      +--------+
                          |
                          |
                          | /------------  Server
                   X1':x1'|/               Reflexive
                    +------------+         Address
                    |    NAT     |
                    +------------+
                          |
                          | /------------  Local
                      X:x |/               Address
                      +--------+
                      |        |
                      | Agent  |
                      |        |
                      +--------+
```
图 2：候选地址的关系

当代理从 IP 地址和端口 X:x 发送 TURN Allocate 请求时，NAT ( 假设有一个 ) 将创建一个绑定X1':x1'，将这个服务器自反候选地址映射到主机候选地址 X:x。从主机候选地址发送出去的数据包将被 NAT 转换为服务器自反的候选地址。发送到服务器自反候选地址的入报文将被 NAT 转换成主机候选地址并转发给代理。与给定的服务器自反候选地址相关联的主机候选地址是“基”。

注：“基” 指的是代理从特定候选地址发送数据的地址。因此，作为简并的情况，主机候选地址也有一个基，但它与主机候选地址是一样的。

当代理和 TURN 服务器之间有多个 NAT 时，TURN 请求会在每个 NAT 上创建一个绑定，但只有最外层的服务器自反候选地址 ( 最接近 TURN 服务器的那个) 会被代理发现。如果代理不在 NAT 之后，那么基候选地址将与服务器自反候选地址相同，并且服务器自反候选地址是冗余的，将被删除。

然后 Allocate 请求到达 TURN 服务器。TURN 服务器从它的本地 IP 地址 Y 分配一个端口 y，并生成一个 Allocate 响应，通知代理这个中继候选地址。通过将 Allocate 请求的源传输地址复制到 Allocate 响应中，TURN 服务器还通知代理，服务器自反候选候选地址 X1':x1'。TURN 服务器充当包中继，在 L 和 R 之间转发流量。为了将流量发送给 L，R 将流量发送给位于 Y:y 的TURN 服务器，TURN 服务器将流量转发给 X1':x1'， X1':x1' 通过 NAT 映射到 X:x，然后传递给 L。

当只使用 STUN 服务器时，代理会向其 STUN 服务器发送 STUN 绑定请求[[RFC5389](https://www.rfc-editor.org/rfc/rfc5389)]。STUN 服务器将通过将绑定请求的源传输地址复制到绑定响应中，来通知代理服务器自反候选地址 X1':x1'。

#### 2.2 连接检查

一旦 L 收集了所有的候选地址，它就会按照从高到低的优先级对它们进行排序，并通过信令通道将它们发送给 R。当 R 从 L 接收到候选地址时，它执行相同的收集过程，并使用自己的候选地址列表进行响应。在这个过程的最后，每个 ICE 代理都有一个完整的候选地址列表和它的对端的候选地址列表。它将它们配对，形成候选地址的配对。要查看哪些对有效，每个代理安排一系列连接检查。每个检查都是一个 STUN 请求/响应事务，客户端将通过从本地候选地址向远程候选地址发送一个 STUN 请求来对特定的候选对执行该事务。

连接检查的基本原理很简单：

1. 按照优先级顺序对候选对排序。
2. 按优先级顺序对每个候选对发送检查。
3. 确认从其它代理收到检查。

两个代理都对一个候选地址对执行检查，结果是一个 4 路握手：
```
                  L                        R
                  -                        -
                  STUN request ->             \  L's
                            <- STUN response  /  check

                             <- STUN request  \  R's
                  STUN response ->            /  check
```
图3：基本连接检查

需要注意的是 STUN 请求发送到发送来的 IP 地址和端口将与用于数据 (例如，RTP、RTCP或其他协议) 的 IP 地址和端口完全一致 。因此，代理使用数据包的内容而不是接收数据包的端口对 STUN 和数据进行多路复用。

因为 STUN 绑定请求用于连接检查，STUN 绑定响应将包含代理的在代理与其对等体之间的任何 NAT 的公网端转换的传输地址。如果这个传输地址与代理已经学习的其它候选地址不同，它代表一个新的候选地址 (对等自反候选地址)，然后由 ICE 进行测试，就像测试任何其它候选地址一样。

因为上面的算法会搜索所有的候选地址对，所以如果存在一个工作对，无论候选地址对以什么顺序尝试，算法最终都会找到它。为了产生更快 (更好) 的结果，候选地址按照指定的顺序排序。排序后的候选地址对的结果列表称为检查表 “checklist”。

代理通过定期为列表中的下一对候选地址对发送 STUN 请求来遍历检查表。这些被称为“普通检查”。当 STUN 事务成功时，一个或多个候选地址对将成为所谓的“有效对”，并将被添加到一个称为 “有效列表” 的候选地址对列表中。

作为优化，只要 R 得到 L 的检查消息，R 就在同一候选对上调度一个连接检查消息发送给 L。这被称为 “被触发的检查”，它加速了寻找有效对的过程。

在握手结束时，L 和 R 都知道他们可以在两个方向端到端地发送 (和接收) 消息。

一般情况下，优先级算法的设计是为了使相似类型的候选地址具有相似的优先级，从而使更直接的路由 (即没有数据中继或 NAT 的路由) 优先于更间接的路由 (有数据中继或 NATs
 的路由)。然而，在这些指导原则的范围内，代理有相当大的自由裁量权来调整它们的算法。

一个数据流可能由多个组件组成 (数据流的各个部分需要它们自己的候选集，例如 RTP 和 RTCP)。

#### 2.3 提名候选地址组合和结束ICE

ICE 将其中一个 ICE 代理分配为控制代理，另一个 ICE 代理分配为被控制代理。对于数据流的每个组件，控制代理指定用于数据的有效对 (来自有效列表)。提名的确切时间取决于本地策略。

当提名时，控制代理让检查至少持续到发现一个对于数据流的每个组件都是有效对的候选地址对，然后挑选一个有效对并在那个对上发送一个 STUN 请求，使用一个属性来向被控制的对端表示它被提名。如图4所示。
```
             L                        R
             -                        -
             STUN request ->             \  L's
                       <- STUN response  /  check

                        <- STUN request  \  R's
             STUN response ->            /  check

             STUN request + attribute -> \  L's
                       <- STUN response  /  check
```
图4：提名

一旦被控制的代理接收到带有属性的 STUN 请求，它将检查 (除非已经进行了检查) 相同的对。如果上面的事务成功，代理将设置对的提名标志，并取消未来对数据流中该组件的任何检查。一旦代理为数据流的每个组件设置了提名标志，这些对就成为选定的对。之后，只有选定的对将用于发送和接收与该数据流相关的数据。

#### 2.4 ICE 重启

一旦 ICE 结束，它可以在任何时间由任一 ICE 代理为一个或所有的数据流重新启动。这是通过发送更新的指示重新启动的候选信地址息来完成的。

#### 2.4 Lite 实现

某些 ICE 代理将始终连接到公共 Internet，并拥有一个公共 IP 地址，在这个地址上它可以接收来自任何通信者的数据包。为了使这些设备更容易支持 ICE，ICE 定义了一种特殊类型的实现，称为 “lite” (与正常的完整实现相比)。Lite 代理只使用主机候选地址，不生成连接检查或运行状态机，尽管它们需要能够响应连接检查。

### 3. ICE 的使用

本文档描述了 ICE 与提供 ICE 代理之间交换候选地址信息的方法的协议的通用用法。使用 ICE (称为 “使用协议”) 的不同协议的具体细节 (例如，如何对候选地址信息进行编码和实际的候选地址交换过程) 将在单独的使用文档中描述。

一种允许代理交换候选地址信息的机制是利用 Offer/Answer 语义 (基于 [[RFC3264](https://www.rfc-editor.org/rfc/rfc3264)]) 作为 SIP 协议 [[RFC3261](https://www.rfc-editor.org/rfc/rfc3261)] [[ICE-SIP-SDP](https://www.rfc-editor.org/rfc/rfc8445.html#ref-ICE-SIP-SDP)] 的一部分。

[[RFC7825](https://www.rfc-editor.org/rfc/rfc7825)] 定义了 RTSP (Real-Time Streaming Protocol) 的 ICE 用法。但是请注意，ICE 的使用是基于 [RFC 5245](https://www.rfc-editor.org/rfc/rfc5245) 的。

### 4. 术语

本文档中的关键词 “MUST”、“MUST NOT”、“REQUIRED”、“SHALL”、“SHALL NOT”、“SHOULD”、“SHOULD NOT”、“RECOMMENDED”、“NOT RECOMMENDED”、“MAY” 和 “OPTIONAL” 应按照 [BCP 14](https://www.rfc-editor.org/bcp/bcp14) [[RFC2119](https://www.rfc-editor.org/rfc/rfc2119)] [[RFC8174](https://www.rfc-editor.org/rfc/rfc8174)] 的描述解释，当且仅当它们以大写字母出现时，如此处所示。

读者需要熟悉 [[RFC5389](https://www.rfc-editor.org/rfc/rfc5389)] 中定义的术语和 UDP 的 NAT 行为要求 [[RFC4787](https://www.rfc-editor.org/rfc/rfc4787)]。:

本规范使用了以下附加术语：

ICE 会话：ICE 会话由所有与 ICE 相关的动作组成，从候选地址收集开始，然后是 ICE 代理之间的交互 (候选地址交换、连接检查、提名和 keepalive)，直到所有候选地址被释放或触发 ICE 重启。

ICE 代理，代理：ICE 代理 (有时简称为 “代理”) 是 ICE 候选地址交换中涉及的协议实现。在一个典型的候选地址交换中涉及两个代理。

发起端点 (Initiating Peer)，发起代理 (Initiating Agent)，发起方 (Initiator)：发起代理是指发起 ICE 候选地址交换过程的 ICE 代理。

响应端点，响应代理，响应者：响应代理 (response agent) 是接收并响应发起代理发起的候选地址交换过程的 ICE 代理。

ICE 候选地址交换，候选地址交换：ICE 代理交换执行 ICE 所需的信息 (如候选地址信息和密码) 的过程。SDP 编码的 Offer/Answer [[RFC3264](https://www.rfc-editor.org/rfc/rfc3264)] 是一个可以用来交换候选地址信息的协议的例子。

对端：从会话中的一个 ICE 代理的角度来看，它的对端是另一个代理。具体来说，从发起代理的角度来看，对端就是响应代理。从响应代理的角度来看，对端是发起代理。

传输地址：IP 地址和传输协议 ( 如 UDP 或 TCP ) 端口的组合。

数据、数据流、数据会话：当使用 ICE 建立数据会话时，数据是使用某种协议传输的。媒体通常通过 RTP 传输，由 RTP 包流组成。数据会话 (Data session) 是指在 ICE 创建并测试的路径上，对等体之间交换的数据报文。

候选地址，候选地址信息：一个传输地址，它可能是接收数据的联络点。候选地址也有属性——它们的类型 (服务器反射、中继或主机)、优先级、基础和基。

组件：组件是数据流的一部分。一个数据流可能需要多个组件，为了使数据流作为一个整体工作，每个组件都必须工作。对于 RTP/RTCP 数据流，除非 RTP 和 RTCP 在同一端口是多路复用的，否则每个数据流都有两个组件 —— 一个用于 RTP，一个用于 RTCP。组件有一个候选地址对，其它组件不能使用该候地址选对。

主机候选地址：从主机的 IP 地址绑定到特定端口获得的候选地址。包括物理接口的 IP 地址和逻辑接口的 IP 地址，如通过 VPN 获取的 IP 地址。

服务器反射候选地址：ICE 代理通过 NAT 向服务器 (如 STUN 服务器) 发送报文后，IP 地址和端口是一个由 NAT 给 ICE 代理分配的绑定的候选地址。

对等体反射候选地址：ICE 代理通过 NAT 向对端发送报文后，IP 地址和端口是一个由 NAT 分配的绑定的候选地址。

中继候选地址：从中继服务器 ( 如 TURN 服务器) 获得的候选地址。

基：ICE 代理发送给某个特定候选地址的源传输地址。对于主机，服务器反射，对端反射候选地址，基与主机候选地址相同。对于中继候选地址，基与中继候选地址相同 (比如，TURN 服务器用于发送数据的源传输地址)。

相关地址和端口：候选地址关联的一个传输地址，用于诊断和其他目的。如果一个候选地址是服务器或对端反射的，则相关的地址和端口等于该服务器或对端反射候选地址的基。如果候选地址是中继的，相关的地址和端口等于 Allocate 响应中映射的为客户端提供了中继候选地址的地址。如果候选地址是主机候选地址，则相关的地址和端口与主机候选地址相同。

基础：冻结算法中用于对相似候选地址进行分组的任意字符串。对于具有相同类型、基本 IP 地址、协议 (UDP、TCP等)、STUN 或 TURN 服务器的两个候选地址，它是一样的。如果其中任何一个不同，那么基础也会不同。

本地候选地址：ICE 代理已经获得并可以发送给其对等体的候选地址。

远程候选地址：ICE 代理从其对端收到的候选地址。

默认目标/候选地址：数据流组件的默认目标地址是 ICE 代理使用的传输地址，而 ICE 不知道该地址。组件的默认候选地址是其传输地址与该组件的默认目标地址匹配的候选地址。

候选地址对：含一个本地候选地址和一个远端候选地址的对。

检查，连接检查，STUN 检查：STUN 绑定请求，用于验证连通性。检查从本地候选地址的基发送到候选地址对的远程候选地址。

检查表：ICE 代理用来生成检查的一组有序的候选地址对。

普通检查：由 ICE 代理生成的连接检查，作为定时触发的定时器的结果，该定时器指示 ICE 代理发送检查。

触发的检查：从对等体接收到连接检查后产生的连接检查。

有效对：一个候选地址对，其本地候选地址等于成功的连接检查响应的映射地址，其远程候选地址等于发送连接检查请求的目的地址。

有效列表：经过成功的 STUN 事务验证的数据流候选地址对的有序集合。

检查表集合：所有检查表的有序列表。顺序由每次 ICE 使用决定。

完全实现：执行本规范定义的完整功能集的 ICE 实现。

精简实现：一种 ICE 实现，它省略了某些功能，只实现那些不是精简实现的对等体所需要的功能，以获得 ICE 的好处。精简实现不维护任何状态机，也不生成连接性检查。

控制代理：提名候选地址对的 ICE 代理。在任何会话中，总是有一个控制代理和一个被控制代理。

被控制代理：等待控制代理提名候选地址对的 ICE 代理。

提名：控制代理向被控制代理指示 ICE 代理将使用哪一对候选地址对来发送和接收数据的过程。本规范中定义的提名过程在 [RFC 5245](https://www.rfc-editor.org/rfc/rfc5245) 中被称为“常规提名”。在 [RFC 5245](https://www.rfc-editor.org/rfc/rfc5245) 中被称为“激进提名”的提名过程在本规范中已被弃用。

被提名，被提名标志：一旦候选地址对的提名成功，该候选地址对就被提名了，其被提名标志的值设置为 true。

已选对，已选候选地址对：数据流组件用于发送和接收数据的候选地址对称为 “已选对”。在为数据流生成已选对之前，任何与数据流的组件关联的有效对都可以用于为该组件发送和接收数据。一旦数据流的每个组件都有提名对，这些提名的对就成为数据流的已选对。与已选对相关联的候选地址称为“已选候选地址对”。

使用协议，ICE使用：使用 ICE 进行 NAT 穿越的协议。使用规范定义了关于这里定义的过程如何应用于该协议的特定于协议的细节。

定时器 Ta：生成新的 STUN 或 TURN 事务的定时器。

定时器 RTO (重传超时)：给定 STUN 或 TURN 事务的重传定时器。

### 5. ICE候选地址收集与交换

作为 ICE 处理的一部分，发起代理和响应代理都会收集候选地址，对候选地址进行排序并消除冗余的候选地址，并按照使用协议 (ICE usage) 的定义与对等体交换候选地址信息。候选地址编码机制的细节和候选地址信息交换的语义超出了本规范的范围。

#### 5.1 完全实现

##### 5.1.1 收集候选地址

ICE 代理认为通信迫在眉睫的时候收集候选地址。发起代理可以根据用户界面提示或明确的请求来发起会话。每个候选地址都有一个传输地址。它还有一个类型和一个基。本规范定义并收集了四种类型——主机候选地址、服务器反射候选地址、对等反射候选地址和中继候选地址。服务器反射候选地址通过 STUN 或 TURN 收集，中继候选地址通过 TURN 获得。对等反射候选地址在 ICE 的后期阶段获得，作为连接检查的结果。

在响应代理上收集候选地址的过程与发起代理的过程相同。建议 (RECOMMENDED) 响应的代理在接收到候选地址信息后立即开始这个过程，在向 ICE 会话关联的应用程序的用户发出警报之前。

###### 5.1.1.1 主机候选地址

主机候选地址通过绑定主机上连接的网卡 (物理或虚拟，包括 VPN 接口) 上的 IP 地址的端口来获得。

对于 ICE 代理希望使用的每个数据流的每个组件，代理应该 (SHOULD) 在主机的每个 IP 地址上获得一个候选地址，下面列出了例外情况。代理通过绑定特定 IP 地址上的 UDP 端口来获取每个候选地址。一个主机候选地址 (实际上是每个候选地址) 总是与它作为候选地址的特定组件相关联。

每个组件都有一个分配给它的ID，称为“组件ID”。对于 RTP/RTCP 数据流，除非 RTP 和 RTCP 在同一个 UDP 端口上多路复用 ( RTP/RTCP 复用)，否则 RTP 本身的组件 ID 为 1，RTCP 的组件 ID 为 2。在 RTP/ RTCP 多路复用的情况下，RTP 和 RTCP 的组件 ID 都为 1。

当获得了候选地址，除非代理确切知道将使用 RTP/RTCP 多路复用 (例如，代理知道其它代理也支持，并愿意使用，RTP/RTCP 多路复用)，或除非代理只支持 RTP/RTCP 多路复用，代理必须 (MUST) 为 RTCP 获得独立的候选地址。如果代理已经获得了 RTCP 候选地址，并且最终使用了 RTP/RTCP 多路复用，那么代理不需要对 RTCP 候选地址执行连接检查。缺少组件 ID 2 并不意味着使用 RTCP/RTP多 路复用，因为它也可能意味着没有使用 RTCP。

如果一个代理使用单独的 RTP 和 RTCP 候选地址，那么如果一个代理有 K 个 IP 地址，它最终会有 2*K 个主机候选地址。

请注意，响应的代理在获取候选地址时，通常会知道其它代理是否支持 RTP/RTCP 多路复用，在这种情况下，它将不需要获取单独的 RTCP 候选地址。然而，缺少组件 ID 2 并不意味着使用 RTCP/RTP 多路复用，因为它也可能意味着没有使用 RTCP。

除了 RTP/RTCP 流之外，不鼓励使用多个组件，因为这会增加 ICE 处理的复杂性。如果需要多个组件，组件 ID 应该 (SHOULD) 以 1 开头，每个组件增加 1。

每个主机候选地址的基设置为候选地址本身。

主机候选地址从所有 IP 地址中收集，除以下例外：

 * 来自还回接口的地址不能 (MUST NOT) 包含在候选地址中。
 * 已弃用的 IPv4 兼容 IPv6 地址 [[RFC4291](https://www.rfc-editor.org/rfc/rfc4291)] 和 IPv6 站点本地单播地址 [[RFC3879](https://www.rfc-editor.org/rfc/rfc3879)] 不能包含在候选地址中。
 * IPv4 映射的 IPv6 地址不应该 (SHOULD NOT) 包含在候选地址中，除非使用 ICE 的应用程序不支持 IPv4 (即，它是一个仅 IPv6 的应用 [[RFC4038](https://www.rfc-editor.org/rfc/rfc4038)])。
 * 如果收集一个或多个与 IPv6 地址对应的候选地址，该地址是使用一种防止位置跟踪的机制生成的 [[RFC7721](https://www.rfc-editor.org/rfc/rfc7721)]，与允许位置跟踪的 IPv6 地址对应的候选地址被配置在同一个接口上，并且是同一个网络前缀的一部分，绝对不能 (MUST NOT) 被收集。类似地，当使用一种防止位置跟踪的机制生成的 IPv6 地址对应的候选地址被收集时，对应 IPv6 链路本地地址的候选地址[[RFC4291](https://www.rfc-editor.org/rfc/rfc4291)]一定不能 (MUST NOT) 被收集。

IPv6 默认地址选择规范 [[RFC6724](https://www.rfc-editor.org/rfc/rfc6724)] 规定临时地址 [[RFC4941](https://www.rfc-editor.org/rfc/rfc4941)] 优先于永久地址。

###### 5.1.1.2 服务器反射和中继候选地址

ICE 代理应该 (SHOULD) 收集服务器反射和中继候选地址。然而，在某些网络中，使用 STUN 和 TURN 服务器可能是不必要的，而且使用 TURN 服务器的成本可能很高，因此一些部署可能选择不使用它们。如果代理不收集服务器反射或中继候选地址，建议 (RECOMMENDED) 实现该功能并通过配置禁用，以便在将来条件改变时可以通过配置重新启用该功能。

代理将每个主机候选地址与配置或通过某种方式发现它的 STUN 或 TURN 服务器配对。建议 (RECOMMENDED) 配置域名，使用 [[RFC5389](https://www.rfc-editor.org/rfc/rfc5389)] (使用 SRV 记录为 "stun" 的服务) 中的 DNS 过程发现 STUN 服务器，使用 [[RFC5766](https://www.rfc-editor.org/rfc/rfc5766)]  (使用 SRV 记录为 "turn" 的服务) 中的 DNS 过程发现 TURN 服务器。

当多个 STUN 或 TURN 服务器可用时 (或者当它们通过 DNS 记录获取并有多个结果返回时)，代理可以 (MAY) 收集所有这些服务器的候选地址，并且应该 (SHOULD) 收集至少一个 (一个 STUN 服务器和一个 TURN 服务器) 的候选地址。它通过将主机候选地址与 STUN 或 TURN 服务器配对来实现这一点，对于每一对，代理从主机候选地址向服务器发送一个 Binding 或 Allocate 请求。发送到 STUN 服务器的 Binding 请求不经过身份验证，响应中的任何 ALTERNATE-SERVER 属性都被忽略。代理必须 (MUST) 支持 [[RFC5389](https://www.rfc-editor.org/rfc/rfc5389)] 中定义的 Binding 请求的向后兼容模式。Allocate 请求应该使用客户端通过其他方式获得的长期凭证进行身份验证。

收集过程使用定时器 Ta 控制。每次 Ta 过期，代理可以生成另一个新的 STUN 或 TURN 事务。此事务可以是前一个因可恢复错误而失败的事务的重试 (例如身份验证失败)，也可以是一个新的主机候选地址和 STUN 或 TURN 服务器对的事务。代理在每次 ta 过期时生成事务的频率不应 (SHOULD NOT) 超过一次。关于如何设置 Ta 和 STUN 重传计时器，RTO，请参阅 [第14节](https://www.rfc-editor.org/rfc/rfc8445.html#section-14)。

代理将收到 Binding 或 Allocate 响应。一个成功的 Allocate 响应将为代理提供一个服务器反射候选地址 ( 从映射地址获得 ) 和一个 XOR-RELAYED-ADDRESS 属性中的中继候选地址。如果 Allocate 请求因为服务器缺乏资源来完成它而被拒绝，代理应该发送一个 Binding 请求来获得一个服务器反射候选地址。Binding 响应将只向代理提供一个服务器反射候选地址 (也从映射的地址获得)。服务器反射候选地址的基是发送 Allocate 或 Binding 请求的主机候选地址。中继候选地址的基是该候选地址本身。如果中继候选地址与主机候选地址相同 (这种情况很少发生)，则必须丢弃中继候选地址。

如果一个 IPv6 代理在一个使用 NAT64 [[RFC6146](https://www.rfc-editor.org/rfc/rfc6146)] 和 DNS64 [[RFC6147](https://www.rfc-editor.org/rfc/rfc6147)] 技术的网络中，它也可能从 IPv4 STUN 或 TURN 服务器收集 IPv4 服务器反射和/或中继候选地址。IPv6-only 代理还应该利用 IPv6 前缀发现[[RFC7050](https://www.rfc-editor.org/rfc/rfc7050)] 来发现 NAT64 使用的 IPv6 前缀(如果有的话)，并相应地为每个 IPv6-only 接口生成服务器反射候选地址。NAT64 服务器反射候选地址与 IPv4 服务器反射候选地址一样具有优先级。

###### 5.1.1.3 计算基础

ICE 代理给每个候选地址分配一个基础 foundation。当两个候选地址都符合以下条件时，它们的基础 foundation 是相同的：

 * 它们具有相同的类型 (主机、中继、服务器反射或对等体反射)。
 * 它们的基具有相同的 IP 地址 (端口可以不同)。
 * 对于反射和中继候选地址，用于获取它们的 STUN 或 TURN 服务器具有相同的 IP 地址 (即代理联系 STUN 或 TURN 服务器时使用的 IP 地址)。
 * 它们使用相同的传输协议 (TCP、UDP) 获得。

类似地，如果它们的类型不同，它们的基有不同的 IP 地址，用来获取它们的 STUN 或 TURN 服务器有不同的 IP 地址 (代理用来联系 STUN 或 TURN 服务器的 IP 地址)，或者它们的传输协议不同，两个候选地址的基础 foundation 也不同。

###### 5.1.1.4 候选地址保活

一旦分配了服务器反射和中继候选地址，必须 (MUST) 对它们保活，直到 ICE 处理完成，如 [章节 8.3](https://www.rfc-editor.org/rfc/rfc8445.html#section-8.3) 所述。对于通过 Binding 请求了解到的服务器反射候选地址，必须通过向服务器发送额外的 Binding 请求来保持绑定处于活动状态。分配的刷新是使用 Refresh 事务完成的，如 [[RFC5766](https://www.rfc-editor.org/rfc/rfc5766)] 所述。Refresh 请求还将刷新服务器反射候选地址。

主机后选地址不会超时，但是后选地址可能会因为一些原因而改变或消失。ICE 代理应该 (SHOULD) 监视它所使用的接口，使基已消失的候选地址无效，并在新的 IP 地址 (在新的或当前使用的接口上) 出现时适当地获取新的候选地址。

##### 5.1.2 候选地址优先级划分

优先级划分过程的结果是为每个候选地址分配一个优先级。数据流的每个候选地址必须 (MUST) 具有一个唯一的优先级，该优先级必须 (MUST) 是 1 到 (2**31 - 1) 之间的正整数。ICE 将使用这个优先级来确定连接检查的顺序和候选地址的相对优先级。优先级越高的值优先级越高。

ICE 代理应使用 [章节 5.1.2.1](https://www.rfc-editor.org/rfc/rfc8445.html#section-5.1.2.1) 中的公式计算该优先级，并根据 [章节 5.1.2.2](https://www.rfc-editor.org/rfc/rfc8445.html#section-5.1.2.2) 中的指导原则选择其参数。如果一个代理选择使用一个不同的公式，ICE 可能需要更长的时间来收敛，因为代理在他们的检查中不会被协调。

对候选地址进行优先级排序的过程在发起者和响应者之间是共同的。

###### 5.1.2.1 推荐的公式

推荐的公式组合了候选地址类型的首选项 (服务器反射、对等体反射、中继和主机)、获得候选地址的 IP 地址的首选项，以及组件 ID，使用以下公式：
```
   priority = (2^24)*(type preference) +
              (2^8)*(local preference) +
              (2^0)*(256 - component ID)
```

类型优先级必须 (MUST) 是 0 (最低优先级) 到包含 126 (最高优先级) 之间的整数，同一类型的所有候选地址必须 (MUST) 相同，不同类型的候选地址必须 (MUST) 不同。对等体反射候选地址的类型优先级必须高于服务器反射候选地址。将值设置为 0 意味着该类型的候选地址将仅作为最后的手段使用。请注意，根据 [第 5.1.1 节](https://www.rfc-editor.org/rfc/rfc8445.html#section-5.1.1) 的过程收集的候选地址永远不会是对等体反射候选地址；这种类型的候选地址是 ICE 从执行的连接检查中获得的。

本地优先级必须 (MUST) 为 0 (最低优先级) ~ 65535 (最高优先级) 之间的整数。当只有单个 IP 地址时，该值应该 (SHOULD) 设置为 65535。如果特定数据流的特定组件有多个具有相同类型的候选地址，则每个候选地址的本地优先级必须 (MUST) 是唯一的。如果 ICE 代理是双栈的，本地优先级应该 (SHOULD) 按照 [[RFC8421](https://www.rfc-editor.org/rfc/rfc8421)] 中描述的当前最佳实践设置。

组件 ID 必须 (MUST) 为 1 ~ 256 之间的整数。

###### 5.1.2.2 选择类型和本地优先级指南

类型优先级的推荐 (RECOMMENDED) 值为：主机候选地址为 126，对等反射候选地址为 110，服务器反射候选地址为 100，中继候选地址为 0。

如果一个 ICE 代理是多主的，并且有多个 IP 地址，应该遵循 [[RFC8421](https://www.rfc-editor.org/rfc/rfc8421)] 中的建议。如果使用多个 TURN 服务器，则从 TURN 服务器获得的候选地址的本地优先级的选择方式与多主本地候选地址的选择方式类似：本地优先级值用于表示不同服务器之间的优先级，但每个服务器的优先级必须是唯一的。

在选择类型优先级时，代理可能会考虑延迟、丢包、成本、网络拓扑、安全、隐私等因素。

##### 5.1.3 消除冗余的候选地址

接下来，ICE 代理 (发起和响应) 消除多余的候选地址。两个候选地址可以有相同的传输地址但不同的基，这些不会被认为是多余的。通常，当代理不在 NAT 之后时，服务器反射候选地址和主机候选地址将是冗余的。当且仅当一个候选地址的传输地址和基与另一个候选地址的相等时，该候选地址是冗余的。代理应消除优先级较低的冗余候选地址。

#### 5.2 精简实现过程

精简实现只使用主机候选地址。对于独立 IP 地址族的每个 IP 地址，必须 (MUST) 有 0 个或 1 个候选地址。精简实现中，ICE 不能用于在候选地址中进行动态选择。因此，不建议 (NOT RECOMMENDED) 从一个特定的 IP 地址族中包含多个候选地址，因为只有连接检查才能真正决定是使用一个地址还是另一个地址。相反，建议 (RECOMMENDED) 拥有多个公网 IP 地址的代理运行完整的 ICE 实现，以确保其地址的最佳使用。

每个组件都有一个分配给它的 ID，称为 “组件ID”。对于 RTP/RTCP 数据流，除非 RTCP 和 RTP 在同一端口进行多路复用，否则 RTP 本身的组件 ID 为 1，RTCP 的组件 ID 为 2。如果一个代理正在使用 RTCP 而不进行多路复用，它必须 (MUST) 为它获得候选地址。然而，缺少组件 ID 2 并不意味着使用 RTCP/RTP 多路复用，因为它也可能意味着没有使用 RTCP。

每个候选地址都被分配一个基础 foundation。对于从不同 IP 地址分配的两个候选地址，foundation 必须 (MUST) 不同；否则，它必须 (MUST) 是相同的。每个 IP 地址增加一个简单的整数就足够了。此外，必须 (MUST) 为同一数据流的所有候选地址分配一个唯一的优先级。如果使用 [5.1.2.1 章节](https://www.rfc-editor.org/rfc/rfc8445.html#section-5.1.2.1) 的公式计算优先级，则类型优先级的值应该 (SHOULD) 设置为126。当主机仅支持 IPv4 时，本地优先级的值应该 (SHOULD) 设置为 65535。当主机为 IPv6 或双栈时，本地优先级值应该 (SHOULD) 设置为 [RFC 6724](https://www.rfc-editor.org/rfc/rfc6724) [[RFC6724](https://www.rfc-editor.org/rfc/rfc6724)] 中描述的 IP 地址的优先级值。

接下来，代理为每个数据流的每个组件选择一个默认候选地址。如果主机只支持 IPv4，那么每个数据流的每个组件都只有一个候选地址；因此，该候选地址是默认地址。如果主机只有 IPv6，默认的候选地址通常是一个全局范围的 IPv6 地址。双栈主机应该 (SHOULD) 允许配置是否使用 IPv4 或 IPv6 作为默认候选地址，并且配置需要基于它的管理员认为在当前网络环境中哪一个有更高的成功机会。

本节中的过程在发起代理和响应代理中是通用的。

#### 5.3 候选地址信息交换

ICE代理 (发起和响应) 需要交换以下关于候选地址的信息。每次使用 ICE 都必须 (MUST) 定义如何与使用协议交换信息。本节描述需要交换的信息。

候选地址：一个或多个候选地址。对于每个候选地址：
    地址：候选地址的 IP 地址和传输协议端口。
    传输：候选地址的传输协议。如果使用协议只在一个传输协议上运行，这可以 (MAY) 省略。
    Foundation：最多 32 个字符的序列。
    组件 ID：候选地址的组件 ID。如果使用协议不使用组件的概念，这可以 (MAY) 省略。
    优先级：候选地址的 32 位优先级。
    类型：候选地址的类型。
    相关地址和端口：候选地址的相关 IP 地址和端口。如果代理不希望显示它们 (例如，出于隐私原因)，可以 (MAY) 忽略它们或将它们设置为无效值。
    可扩展性参数：使用协议可以定义将来添加每候选地址 ICE 参数的方法。

精简或完整：代理是精简代理还是完整代理。

连接性检查平滑值：代理希望使用的连接性检查平滑值。如果代理希望使用已定义的默认值，则可以 (MAY) 省略此选项。

用户名片段和密码：用于执行连接性检查的值。这些值必须 (MUST) 是不可猜的，至少有 128 位随机数生成器输出用于生成密码，至少有 24 位输出用于生成用户名片段。

扩展：新的媒体流或会话级属性 (ICE选项)。

如果使用的协议容易受到 ICE 不匹配的攻击 ([章节5.4](https://www.rfc-editor.org/rfc/rfc8445.html#section-5.4))，并且能够检测到，则需要一种方法让检测代理将该信息传递给它的对等体。它是一个布尔标志。

使用协议可能 (也可能不) 需要处理与不支持 ICE 的旧实现的向后兼容性。如果支持并正在使用一种到非 ICE 的回退机制，那么使用协议除了提供 ICE 参数外，大概还提供了一种传递默认候选地址参数 (其IP地址和端口) 的方法。

一旦代理发送了它的候选地址信息，它必须准备好接收 STUN 和每个候选地址的数据包。正如 [12.1 节](https://www.rfc-editor.org/rfc/rfc8445.html#section-12.1) 所讨论的，数据包可以在候选地址作为默认目的地出现之前发送给它。

#### 5.4 ICE 不匹配

某些中间件，如 ALGs，可以以破坏 ICE 的方式改变信令信息 (例如，通过重写 SDP 中的 IP 地址)。这被称为 “ICE不匹配”。如果使用协议容易受到 ICE 不匹配的影响，则响应代理需要能够检测到，并将 ICE 不匹配的情况通知对端 ICE 代理。

每个使用协议都需要定义使用协议是否容易受到 ICE 失配的影响，如何检测 ICE 失配，以及检测到 ICE 失配时是否需要采取具体的措施。











原文：[Interactive Connectivity Establishment (ICE): A Protocol for Network Address Translator (NAT) Traversal](https://www.rfc-editor.org/rfc/rfc8445.html)
